---
title: "Comparative effectiveness of BNT162b2 versus mRNA-1273 boosting in England: a cohort study in OpenSAFELY-TPP"
output:
  html_document:
    self_contained: yes
  pdf_document:
    toc: no
  word_document: default
  rtf_document:
    toc: no
  bookdown::html_document2:
    number_sections: no
    toc: no
bibliography: references.bib
csl: vancouver.csl
link-citations: yes
zotero: yes
header-includes:
- \usepackage{float} 
- \floatplacement{figure}{H}
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
- \captionsetup[table]{labelformat=empty}
---

```{r setup, include=FALSE, message=FALSE}

library('tidyverse')
library('here')
library('glue')
library('lubridate')
library('gt')
library('patchwork')
library('scales')

# remotes::install_github("https://github.com/wjchulme/osutils")
# library('osutils')

# where are the outputs (ie the inputs for this manuscript!) saved?
#output_dir_os <- here("output", "release-objects")
output_dir_os <- here("released-output", "release-objects")

# where should we put the objects created within this rmd script?
output_dir_rmd <- here("write-up", "figures")
fs::dir_create(output_dir_rmd)

# only applicable if `self-contained: yes` option is enables in yaml header
knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = paste0(output_dir_rmd, "/"),
  fig.pos = 'H' #to stop figures floating around when rendering to pdf
)

## Import custom user functions from lib
source(here("lib", "functions", "utility.R"))

## Import design elements
source(here("lib", "design", "design.R"))


  outcomes <- 
    c(
      "postest",
      #"covidemergency",
      "covidadmitted",
      #"covidadmittedproxy1",
      #"covidcritcare",
      "coviddeath"
      #"noncoviddeath"
    ) %>% 
    set_names(., .)





```

```{r match-A, echo=FALSE, warning=FALSE, message=FALSE}



matchA_flowchart <-  read_csv(fs::path(output_dir_os, "A", "match_flowchart.csv"))
matchB_flowchart <-  read_csv(fs::path(output_dir_os, "B", "match_flowchart.csv"))

match_flowchart <-
  bind_rows(
    matchA_flowchart %>% 
      mutate(
        criteria = if_else(crit=="c7", "and matched with strategy A", criteria),
        crit=if_else(crit=="c7", "c7A", crit), 
      ),
    matchB_flowchart %>% 
      mutate(
        criteria = if_else(crit=="c7", "and matched with strategy B", criteria),
        crit=if_else(crit=="c7", "c7B", crit), 
      ) %>%
      filter(
        crit=="c7B"
      )
  ) %>%
  arrange(vax3_type, crit)

matchA_coverage <- read_csv(fs::path(output_dir_os, "A", "match_coverage.csv")) %>%
   mutate(
    treatment_descr = fct_recoderelevel(as.character(treatment),  recoder$treatment),
    #status = if_else(status=="matched", "matchedA", status)
  ) %>%
  rename(nA=n, cumulnA=cumuln)

matchB_coverage <- read_csv(fs::path(output_dir_os, "B", "match_coverage.csv")) %>%
   mutate(
    treatment_descr = fct_recoderelevel(as.character(treatment),  recoder$treatment),
    #status = if_else(status=="matched", "matchedB", status)
  )%>%
  rename(nB=n, cumulnB=cumuln)


match_coverage <-
  bind_rows(
    matchA_coverage %>% filter(status=="unmatched"),
    left_join(
      matchA_coverage, 
      matchB_coverage, 
      by=c("treatment", "treatment_descr", "status", "status_descr", "vax3_date")
    ) %>% 
      filter(status=="matched") %>% 
      mutate(strategy="A"),
    matchB_coverage %>% 
      filter(status=="matched") %>% 
      mutate(strategy="B"),
  ) %>%
  mutate(
    n = case_when(
      is.na(strategy) ~ nA,
      strategy=="A" ~ nA-nB,
      strategy=="B" ~ nB
    ),
    cumuln = case_when(
      is.na(strategy) ~ cumulnA,
      strategy=="A" ~ cumulnA-cumulnB,
      strategy=="B" ~ cumulnB
    ),
    status = case_when(
      is.na(strategy) ~ "unmatched",
      strategy=="A" ~ "matched (A only)",
      strategy=="B" ~ "matched (A and B)"
    ),
    status_descr = fct_case_when(
      is.na(strategy) ~ "Unmatched",
      strategy=="A" ~ "Matched (strategy A only)",
      strategy=="B" ~ "Matched (strategy A and B)"
      
    ),
  )




matchA_table1 <- read_csv(fs::path(output_dir_os, "A", "match_table1.csv"))
matchA_table1by <- read_csv(fs::path(output_dir_os, "A", "match_table1by.csv"))

matchB_table1 <- read_csv(fs::path(output_dir_os, "B", "match_table1.csv"))
matchB_table1by <- read_csv(fs::path(output_dir_os, "B", "match_table1by.csv"))

match_table1 <- 
  bind_rows(
    matchA_table1 %>% mutate(strategy="A"),
    matchB_table1 %>% mutate(strategy="B"),
  )

matchset <- "B"


ci_estimates <- read_csv(fs::path(output_dir_os, matchset, "ci_estimates.csv")) %>% 
  mutate(
    outcome_descr = fct_recoderelevel(as.character(outcome),  recoder$outcome),
    subgroup_descr = fct_recoderelevel(subgroup,  recoder$subgroup),
    subgroup_level_descr = replace_na(subgroup_level_descr, "")
  )
contrasts_daily <- read_csv(fs::path(output_dir_os, matchset, "ci_contrasts_daily.csv")) %>% 
  mutate(
    outcome_descr = fct_recoderelevel(as.character(outcome),  recoder$outcome),
    subgroup_descr = fct_recoderelevel(subgroup,  recoder$subgroup),
    subgroup_level_descr = replace_na(subgroup_level_descr, "")
  )
contrasts_cuts <- read_csv(fs::path(output_dir_os, matchset, "ci_contrasts_cuts.csv")) %>%
  mutate(
    outcome_descr = fct_recoderelevel(as.character(outcome),  recoder$outcome),
    subgroup_descr = fct_recoderelevel(subgroup,  recoder$subgroup),
    subgroup_level_descr = replace_na(subgroup_level_descr, "")
  )
contrastsA_overall <- read_csv(fs::path(output_dir_os, "A", "ci_contrasts_overall.csv")) 
contrastsB_overall <- read_csv(fs::path(output_dir_os, "B", "ci_contrasts_overall.csv"))

contrasts_overall <- 
  bind_rows(
    contrastsA_overall %>% mutate(strategy="A"),
    contrastsB_overall %>% mutate(strategy="B"),
  ) %>%
  mutate(
    outcome_descr = fct_recoderelevel(as.character(outcome),  recoder$outcome),
    subgroup_descr = fct_recoderelevel(subgroup,  recoder$subgroup),
    subgroup_level_descr = fct_inorder(replace_na(subgroup_level_descr, "")),
  )


perN <- 1000
perN_format <- label_number(1, 1, big.mark=",")(perN)

label_number_n <- label_number(1, 1, big.mark=",")
label_number_risk <- label_number(0.01, perN, style_negative="minus", big.mark=",")
label_number_rr <- label_number(0.01, 1, style_negative="minus")



contrasts_overall_table <-
  contrasts_overall %>%
  mutate(
    outcome,
    outcome_descr,
    subgroup,
    subgroup_descr,
    subgroup_level_descr,
    n.event = label_number_n(n.event_0+n.event_1),
    persontime_weeks = label_number_n((persontime_0 + persontime_1) / 7),
    n.atrisk = label_number_n(n.atrisk_0),
    persontime_0=label_number_n(persontime_0/7), 
    persontime_1=label_number_n(persontime_1/7),
    n.event_0=label_number_n(n.event_0), 
    n.event_1=label_number_n(n.event_1),
    
    risk.ll_0 = 1-surv.ul_0,
    risk.ul_0 = 1-surv.ll_0,
    risk.ll_1 = 1-surv.ul_1,
    risk.ul_1 = 1-surv.ll_1,
    riskCI_0 = glue("{label_number_risk(risk_0)} ({label_number_risk(risk.ll_0)} to {label_number_risk(risk.ul_0)})"),
    riskCI_0_95 = glue("{label_number_risk(risk_0)} (95%CI {label_number_risk(risk.ll_0)} to {label_number_risk(risk.ul_0)})"),
    riskCI_1 = glue("{label_number_risk(risk_1)} ({label_number_risk(risk.ll_1)} to {label_number_risk(risk.ul_1)})"),
    cirdCI = glue("{label_number_risk(cird)} ({label_number_risk(cird.ll)} to {label_number_risk(cird.ul)})"),
    cirdCI_95 = glue("{label_number_risk(cird)} (95%CI {label_number_risk(cird.ll)} to {label_number_risk(cird.ul)})"),
    #cirrCI = glue("{label_number_rr(cirr)} ({label_number_rr(cirr.ll)}-{label_number_rr(cirr.ul)})"),
    #kmirrCI =   glue("{label_number_rr(kmirr)} ({label_number_rr(kmirr.ll)}-{label_number_rr(kmirr.ul)})"),
    coxhrCI =   glue("{label_number_rr(coxhr)} ({label_number_rr(coxhr.ll)} to {label_number_rr(coxhr.ul)})"),
    coxhrCI_95 =   glue("{label_number_rr(coxhr)} (95%CI {label_number_rr(coxhr.ll)} to {label_number_rr(coxhr.ul)})"),
  ) 

```

William J Hulme^1^, Elsie Horne^3,4^, Ruth Keogh^2^, Edward PK Parker^2^, Venexia Walker^3,5^, Elizabeth J Williamson^2^, Tom Palmer^3,5^, Linda Nab^1^, Helen J Curtis^1^, Ben Goldacre^1^, Miguel A Hernán^8,9^, Jonathan AC Sterne^3,4,7^, and the OpenSAFELY collaborative.

1\. The Bennett Institute for Applied Data Science, Nuffield Department of Primary Care Health Sciences, University of Oxford, OX26GG, UK

2\. London School of Hygiene and Tropical Medicine, Keppel Street, London, WC1E 7HT, UK

3\. Population Health Sciences, University of Bristol, Oakfield House, Oakfield Grove, Bristol, BS8 2BN, UK

4\. NIHR Bristol Biomedical Research Centre, Bristol, UK

5\. MRC Integrative Epidemiology Unit, Bristol Medical School, University of Bristol, Bristol, UK

6\. TPP, TPP House, 129 Low Lane, Horsforth, Leeds, LS18 5PX

7\. Health Data Research UK South West

8\. CAUSALab, Harvard T.H. Chan School of Public Health, Boston, MA 02115

9\. Departments of Epidemiology and Biostatistics, Harvard T.H. Chan School of Public Health, Boston, MA 02115

\newpage

## Abstract

*Introduction* The BNT162b2 and mRNA-1273 vaccines were both widely used for COVID-19 booster vaccination in England, and are both effectiveness against COVID-19 related outcomes, particularly severe outcomes. Direct comparisons of the effectiveness of these two vaccine types when used for boosting have not been made in trials or observational data.

*Methods* Using the OpenSAFELY-TPP linked electronic health record database, we matched adult recipients of each vaccine type on date of vaccination, primary vaccine course, prior SARS-CoV-2 infection, and other important demographic and clinical characteristics. Recipients were eligible for inclusion if boosted between 29 October 2021 to 31 January 2022, and following up for 12 weeks. Outcomes were positive SARS-CoV-2 test, COVID-19 hospitalisation, and COVID-19 death. We used the Aalen-johansen estimator to obtain the cumulative incidence of each outcome, and compared these using risk differences (RD) and hazard ratios (HRs).

*Results* `r label_number(1, big.mark=",")(filter(match_flowchart, crit=="c7B", vax3_type=="pfizer") %>% pull(n))` people were matched in each group, contributing a total of `r contrasts_overall_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(persontime_weeks)` person-weeks of follow-up. The 12-week risk per `r perN_format` people of positive SARS-CoV-2 test for those receiving BNT162b2 and mRNA-1273 was `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="all") %>% pull(riskCI_0_95)` and `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="all") %>% pull(riskCI_1)` (RD `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="all") %>% pull(cirdCI_95)`; HR `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="all") %>% pull(coxhrCI_95)`) respectively.

*Conclusion* COVID-19-related outcomes after booster vaccination with BNT162b2 or mRNA-1273 were rare, and the risk was slightly lower for mRNA-1273 than for BNT162b2. These finding were broadly consistent across subgroups.

\newpage

## Background

The UK COVID-19 vaccination programme delivered its first "booster" doses in September 2021 @NHSEnglandNHS. Following guidance from the Joint Committee for Vaccination and Immunisation (JCVI) expert advisory group@covid19 boosting followed a staged roll-out that prioritised groups at high risk of infection or severe disease, and was then progressively extended to the whole adult population by mid December 2021 @NHSEnglandNHSb @NHSEnglandNHSa1 @NHSEnglandNHSa2. The BNT162b2 Pfizer-BioNTech vaccine was used initially for boosting, with a half-dose of Moderna mRNA-1273 subsequently also used. The concurrent administration of the BNT162b2 and mRNA-1273 vaccines for boosting in England, receipt of which was largely determined by local availability rather than any clinical criteria, enables a direct comparison of their effectiveness. No randomised trials have made such a comparison for efficacy outcomes. 

On behalf of NHS England, we used the OpenSAFELY-TPP database, covering 40% of English primary care practices in England and linked to national coronavirus surveillance, hospital episodes, and death registry data, to compare the effectiveness of BNT162b2 and mRNA-1273 boosting in adult recipients.

\newpage 

## Methods

## Data source

All data were linked, stored and analysed securely within the OpenSAFELY platform: <https://opensafely.org/>. With the approval of NHS England, primary care records managed by the GP software provider TPP were linked, using NHS numbers, to A&E attendance and in-patient hospital spell records via NHS Digital's Hospital Episode Statistics (HES), national coronavirus testing records via the Second Generation Surveillance System (SGSS), and national death registry records from the Office for National Statistics (ONS). COVID-19 vaccination history is available in the GP record directly via the National Immunisation Management System (NIMS).

## Eligibility criteria

We considered all adults (aged 18 years and over) who received a booster dose of BNT162b2 or mRNA-1273 between `r format(as.Date(study_dates$studystart_date), "%e %B")` and `r format(as.Date(study_dates$studyend_date), "%e %B %Y")` inclusive, during which time both vaccine brands were being used. People were eligible if they: were registered at a GP practice using TPP's SystmOne clinical information system at the time of boosting; received a two-dose primary vaccination course of either BNT162b2 or ChAdOx1-S (mixed dosing and mRNA-1273 were not considered due to small numbers); were not a health or social care worker, not resident in a care or nursing home and not medically housebound or receiving end-of-life care; had no evidence of SARS-CoV-2 infection or COVID-19 disease within the previous 90 days; were not hospitalised at the time of boosting; and had complete information on sex, deprivation, and NHS region (defined using Sustainability and Transformation Partnerships (STP, a geographical grouping of NHS and local authorities).

## Matching

BNT162b2 booster recipients were matched with mRNA-1273 booster recipients in a one to one ratio without replacement, on the following characteristics: date of booster dose; primary vaccine course (BNT162b2 or ChadOx1-S); Date of second vaccine dose (7 day caliper); sex (male or female); age (3 year caliper and within age groups defined by JVCI risk groups); Clinical risk group defined by JCVI (clinically extremely vulnerable, clinically at-risk, neither); Index of Multiple Deprivation (IMD, grouped by quintile); STP as a surrogate for geographical region; evidence of prior SARS-CoV-2 infection (any of positive SARS-CoV-2 test, probable infection documented in primary care, or COVID-19 hospital attendance or admission); morbidity count (0, 1, or 2 or more of diabetes, BMI over 40kg/m^2^, chronic heart disease, chronic kidney disease, chronic liver disease, chronic respiratory disease or severe asthma, chronic neurological disease). The supplementary materials provide more information on how these characteristics were defined. 

<!-- #### Matching strategies -->

<!-- ```{r, table-jcvi, echo=FALSE, message=FALSE, warning=FALSE} -->

<!-- tribble( -->
<!--   ~Factor, ~Description, ~A, ~B, -->

<!--   "Date of booster dose",  "Matched exactly",   -->
<!--     "X", "X", -->
<!--   "Primary course vaccine brand", "BNT162b2; ChadOx1-S",  -->
<!--     "X", "X", -->
<!--   "Date of second vaccine dose", "7 day caliper",  -->
<!--     "X", "X", -->
<!--   "Age",  "3 year caliper",  -->
<!--     "X", "X", -->
<!--   "JCVI age group", "18-39; 40-49; 50-54; 55-59; 60-64; 65-69; 70-75; 75-79; 80 and over", -->
<!--     "X", "X", -->
<!--   "JCVI Clinical risk group", "clinically extremely vulnerable; clinically at-risk; neither", -->
<!--     "X", "X", -->
<!--   "English Index of Multiple Deprivation", "Grouped by quintile", -->
<!--     "X", "X", -->
<!--   "NHS region", "East of England; Midlands; London; North East and Yorkshire; North West; South East; South West", -->
<!--     "X", "", -->
<!--   "Sustainability and Transformation Partnership (STP)", "a geographical grouping of NHS and local authorities", -->
<!--     "", "X", -->
<!--   "Sex", "Male; Female", -->
<!--     "", "X",  -->
<!--   "Evidence of prior SARS-CoV-2 infection", 'Any of: positive SARS-CoV-2 test; "probable" infection documented in primary care; COVID-19 hospital admission', -->
<!--     "", "X", -->
<!--   "Morbidity count", "0, 1, or 2 or more of the following conditions: diabetes; BMI over 40kg/m^2^; chronic heart disease; chronic kidney disease; chronic liver disease; chronic respiratory disease or severe asthma; chronic neurological disease",  -->
<!--     "", "X" -->
<!-- ) %>% -->
<!-- gt() %>% -->
<!-- tab_spanner( -->
<!--   label = "Matching strategy", -->
<!--   columns = all_of(c("A", "B")) -->
<!-- ) %>% -->
<!-- fmt_markdown(columns = TRUE) -->

<!-- cat("  \n\n") -->
<!-- ``` -->


## Outcomes and follow-up

We considered three effectiveness outcomes. Positive SARS-CoV-2 test, identified using SGSS testing records and based on swab date. Both polymerase chain reaction (PCR) and lateral flow test results are included, without differentiation between symptomatic and asymptomatic infection. COVID-19 hospital admission, identified using HES in-patient hospital records with U07.1 or U07.2 ICD-10 reason for admission codes @emergenc. COVID-19 death, defined as deaths with U07.1 or U07.2 ICD-10 codes mentioned anywhere on the death certificate (i.e., as an underlying or contributing cause of death).



<!-- We also considered the follows safety outcomes: -->

<!-- * Adverse allergic reaction / Anaphylaxis -->

<!-- * Myocarditis or Pericarditis -->

<!-- *  -->

<!--# COVID-19 related A&E attendance and critical/intensive care admission we also considered but there were doubts over data the reliability of event ascertainment in these cases. -->


Each person was followed from the day of boosting (i.e., time zero) until the earliest of the outcome of interest, death, practice de-registration, 12 weeks, or `r format(as.Date(study_dates$followupend_date), "%e %B %Y")`.

## Statistical Analysis

We estimated the cumulative incidence in each treatment group using the Aalen-Johansen estimator. COVID-19 and non-COVID-19 deaths were treated as competing events. Risk differences (RD) and hazard ratios (RRs) comparing the cumulative incidences were derived at 12 weeks. We also estimated hazard ratios (HRs) comparing booster vaccine groups using Cox models.

<!-- 95% confidence limits for the AJ estimates were derived from a Greenwood-type formula. Confidence limits for the risk difference were derived from the sum of squares of the AJ standard errors, derived from Greenwood’s formula. Confidence limits for the survival ratio were based on the standard error of the cumulative hazard. Confidence limits for the risk ratio were derived using the Delta method. -->

<!-- 95% confidence limits for the KM estimates, risk differences, risk ratios, and incidence rate ratios are derived by bootstrapping the matched pairs. 500 bootstrap replicates will be used. -->

<!-- [The primary estimand is the average treatment effect in the recruited population. To estimate this, expected cumulative incidence rates are estimated for each participant assuming treatment was received by everyone in both treatment groups at time zero. These curves are then averaged over all participants to give the marginal cumulative incidence. This is repeated assuming nobody is treated in either group, and their difference taken. Calculating standard errors for these quantities is challenging, whether approached analytically (due to complex variance components) or computationally (via bootstrapping, due to the large sample sizes involved) and are therefore not reported. ] -->

## Subgroup analyses

We estimated comparative effectiveness separately in the following subgroups: primary vaccine course (ChAdOx1-S or BNT162b2); age (18-64 or $\ge$ 65 years); clinical vulnerability, as defined by JCVI (Not clinical at-risk, clinically at-risk, or clinically extremely vulnerable); evidence of prior SARS-CoV-2 infection or not.

## Software, code, and reproducibility

Data management and analyses were conducted in Python version 3.8.10 and R version 4.0.2. All code is shared openly for review and re-use under MIT open license at <https://github.com/opensafely/comparative-booster>. The supplementary materials provide further details of the codelists and data sources used for all variables in the study. Detailed pseudonymised patient data is potentially re-identifiable and therefore not shared.

## Disclosure control

To satisfy strict re-identification minimisation requirements for statistical outputs from OpenSAFELY's secure environment, all counts were reported to the nearest $6n-3$ ($3, 9, 15, 21, ...$). Zero counts were unchanged. Similarly, the Aalen-Johansen cumulative incidence estimates were rounded such that each "step" is based on at least 6 events. 


\newpage 

# Results

## Study population and matching

`r label_number(1, big.mark=",")(filter(match_flowchart, crit=="c0") %>% pull(n) %>% sum)` adults registered at a TPP practice received a booster vaccination of either BNT162b2 (`r label_number(1, big.mark=",")(filter(match_flowchart, crit=="c0", vax3_type=="pfizer") %>% pull(n))`) or mRNA-1273 (`r label_number(1, big.mark=",")(filter(match_flowchart, crit=="c0", vax3_type=="moderna") %>% pull(n))`) during the study period, with `r label_number(1, big.mark=",")(filter(match_flowchart, crit=="c6", vax3_type=="pfizer") %>% pull(n))` (`r label_percent(0.1)(filter(match_flowchart, crit=="c6", vax3_type=="pfizer") %>% pull(pct_all))`) and `r label_number(1, big.mark=",")(filter(match_flowchart, crit=="c6", vax3_type=="pfizer") %>% pull(n))` (`r label_percent(0.1)(filter(match_flowchart, crit=="c6", vax3_type=="moderna") %>% pull(pct_all))`) eligible for matching.

<!-- Baseline characteristics of the eligible groups before matching showed... (supplementary Table 1). -->

`r label_number(1, big.mark=",")(filter(match_flowchart, crit=="c7B", vax3_type=="pfizer") %>% pull(n))` were matched in each group, `r label_percent(0.1)(filter(match_flowchart, crit=="c7B", vax3_type=="pfizer") %>% pull(pct_step))` and `r label_percent(0.1)(filter(match_flowchart, crit=="c7B", vax3_type=="moderna") %>% pull(pct_step))` respectively (Figure 1).

Characteristics were well-balanced between vaccine types at the start of follow up (Table 2), and the proportion of people with prior clinical conditions was generally similar between the groups, with the standardised mean difference consistently below 0.1 (supplementary Figure 2).

## Estimated comparative effectiveness

### Main analysis

There were `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="all") %>% pull(n.event)` positive SARS-CoV-2 tests, `r contrasts_overall_table %>% filter(strategy=="B", outcome=="covidadmitted", subgroup=="all") %>% pull(n.event)` COVID-19 hospitalisations, and `r contrasts_overall_table %>% filter(strategy=="B", outcome=="coviddeath", subgroup=="all") %>% pull(n.event)` COVID-19 deaths at 12-weeks, across `r contrasts_overall_table %>% filter(strategy=="B", outcome=="coviddeath", subgroup=="all") %>% pull(persontime_weeks)` person-weeks of follow-up (Table 3).

Absolute risks at 12 weeks of positive SARS-CoV-2 test for those receiving BNT162b2 and mRNA-1273 were `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="all") %>% pull(riskCI_0_95)` and `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="all") %>% pull(riskCI_1)` per `r perN_format` people respectively, representing a risk difference of `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="all") %>% pull(cirdCI_95)` and a hazard ratio of `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="all") %>% pull(coxhrCI_95)` (Table 3, Figure 3). Corresponding 12-week risks for COVID-19 hospitalisation were `r contrasts_overall_table %>% filter(strategy=="B", outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_0)` and `r contrasts_overall_table %>% filter(strategy=="B", outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_1)` per `r perN_format` people (RD `r contrasts_overall_table %>% filter(strategy=="B", outcome=="covidadmitted", subgroup=="all") %>% pull(cirdCI)`; HR `r contrasts_overall_table %>% filter(strategy=="B", outcome=="covidadmitted", subgroup=="all") %>% pull(coxhrCI)`), and for COVID-19 death were `r contrasts_overall_table %>% filter(strategy=="B", outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_0)` and `r contrasts_overall_table %>% filter(strategy=="B", outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_1)` per `r perN_format` people (RD `r contrasts_overall_table %>% filter(strategy=="B", outcome=="coviddeath", subgroup=="all") %>% pull(cirdCI)`; HR `r contrasts_overall_table %>% filter(strategy=="B", outcome=="coviddeath", subgroup=="all") %>% pull(coxhrCI)`).

### Subgroup analyses

Whilst absolute risks differed between subgroups, and therefore so did the absolute risk differences comparing vaccine types, subgroup-specific hazard ratios were broadly similar. 

A notable exception was outcomes stratified by primary vaccination series: the estimated benefit of mRA-1273 over BNT162b2 was higher amongst those who received BNT162b2 for their first two vaccine doses (HR for positive SARS-CoV-2 `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="vax12_type", subgroup_level=="pfizer-pfizer") %>% pull(coxhrCI)`) compared with ChAdOx1 (HR `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="vax12_type", subgroup_level=="az-az") %>% pull(coxhrCI)`).

## Discussion

This observational study in over 4 million adults compares the effectiveness of BNT162b2 and mRNA-1273 vaccines against COVID19-related outcomes in the national booster vaccination programme in England. We estimated that mRNA-1273 provided slightly more protection than BNT162b2 did against a positive SARS-CoV-2 test (RD = `r contrasts_overall_table %>% filter(strategy=="B", outcome=="postest", subgroup=="all") %>% pull(cirdCI_95)` per `r perN_format`) and hospitalisation (RD = `r contrasts_overall_table %>% filter(strategy=="B", outcome=="covidadmitted", subgroup=="all") %>% pull(cirdCI_95)`) in the first 12 weeks after boosting. For COVID-19 death, the difference was equivocal (RD = `r contrasts_overall_table %>% filter(strategy=="B", outcome=="coviddeath", subgroup=="all") %>% pull(cirdCI_95)`) though there were only `r contrasts_overall_table %>% filter(strategy=="B", outcome=="coviddeath", subgroup=="all") %>% pull(n.event)` events across both vaccine types, limiting statistical power.

Around 1 in 10 people had a positive SARS-CoV-2 test in the 12 weeks following booster vaccination reflecting both the high infection rates in the study period, particularly from December 2021 onward, and the imperfect protection booster vaccination offers against infection. However, rates of severe disease were rare: after 12-weeks, fewer than 1 in 1,000 booster recipients were hospitalised with COVID-19, and fewer than 1 in 20,000 died due to COVID-19 disease.

Comparative effectiveness against severe outcomes appeared similar regardless of age, clinically vulnerability, or whether there was evidence of prior infection or not. However, the relative advantage of mRNA-1273 against severe COVID-19 was even higher in people who primary vaccination course was BNT162b2 compared with ChAdOx1. That is, the relative benefit of BNT162b2-BNT162b2-mRNA1273 versus BNT162b2-BNT162b2-BNT162b2 was greater than that of ChAdOx1-ChAdOx1-mRNA1273 versus ChAdOx1-ChAdOx1-BNT162b2, at the point of a booster dose onwards. This suggests a benefit of heterologous boosting.

### Strengths and weaknesses

The OpenSAFELY-TPP database covers around 40% of the English population and contains rich clinical information which enabled us to closely match BNT162b2 and mRNA-1273 recipients to control for potential confounding, to study a range of clinical outcomes, including rare outcomes, and to investigate important clinical subgroups.

To make fair comparisons between the two vaccine types, we exploited the concurrent roll-out of both vaccines across the same eligible population in the same time period. The type of vaccine administered was based largely on local supply and availability, and clinical characteristics did not inform the type of vaccine offered on-site. Thus vaccine allocation was, to some degree, random. It remained important to control for any potential differences in the distribution of confounding characteristics between the two vaccine groups, and these were reasonably balanced after matching. We cannot rule out residual confounding, but crucially many unmeasured confounders, particularly those relating to health-seeking behaviours, are far less problematic in comparative effectiveness studies (compared with studies comparing vaccinated with unvaccinated people) as all people entering the study have sought and received a booster dose. Notably, the apparent benefit of mRNA-1273 versus BNT162b2 against positive SARS-CoV-2 test was less pronounced for matching strategy B versus A, suggesting some additional confounder control for this outcome with closer matching, but estimates were similar across strategies for more severe outcomes where outcome ascertainment is more reliable. 

<!--# [People were usually not offered a choice of vaccine type (although they could refuse boosting if they were not offered their preference) and clinical characteristics did not inform the type of vaccine offered. Anecdotally, we understand that occasionally some people were offered a choice in centres using both vaccines, though we are not aware of any specific policy that allowed this.] -->

We excluded certain groups who were unlikely to undergo boosting such as those with a recent positive test and those in palliative care. We also excluded groups where we could not reliably capture high heterogeneity in outcome risk such as those living in care homes and health and social care workers. This may limit the generalisability of out findings.

To control for spatio-temporal heterogeneity in infection risk during the study period we matched on the date of booster receipt and local health administration (STP). However, some residual heterogeneity within STP regions is possible, though more precise geographical matching on middle layer super output areas {<https://www.ons.gov.uk/methodology/geography/ukgeographies/censusgeography>} was not feasible due to poor matching success at this level, partly due to time periods where only one vaccine type was available within a small geographical area.

Some outcomes may be under-ascertained. Positive SARS-CoV-2 tests only include those reported via the national COVID-19 surveillance system (SGSS), and so many asymptomatic and some symptomatic infections will be missed. Positive SARS-CoV-2 testing is therefore not a reliable surrogate for SARS-CoV-2 infection. Some COVID-19 hospitalisations resulting in longer hospital stays may have been missed as these events are only reported once the patient has been discharged.

### Findings in context

The COV-BOOST phase II trial assessed the safety and immunogenicity of seven COVID-19 vaccines for boosting, including BNT162b2 and mRNA-1273 against a menACWY control in people with no prior history of infection @munro2021. It found higher reactogenicity of mRNA-1273 compared with BNT162b2 in subgroups with a two-dose BNT162b2 primary course (geometric mean ratio (GMR) of SARS-CoV-2 anti-spike IgG versus control = 11.49 (95%CI 9.36 to 14.12) versus (6.78 (5.51 to 8.35)) and a two-dose ChAdOx1 primary course (GMR = 32.30 (24.84 to 42.01) versus 16.80 (12.97 to 21.76)). The trial is under-powered to study efficacy endpoints, and we are aware of no other RCTs where direct BNT162b2 versus mRNA-1273 comparisons for boosting are planned or published.

We believe this is the first study to compare BNT162b2 and mRNA-1273 in the context of booster vaccination in observational data, though comparisons have been made for primary vaccination. A study using data from the US Veteran Affairs health care system during the Alpha period using a similar matching approach to the present study @dickerman2022, identified an additional 1.23 (95% CI 0.72 to 1.81) documented infections per 1,000 people in those with a BNT162b2 first dose compared with a mRNA-1273 first dose at 24 weeks, 0.55 (95%CI 0.36 to 0.83) COVID-19 hospitalisations, 0.10 (95%CI 0.00 to 0.26) COVID-19 ICU admissions, and 0.02 (95%CI −0.06 to 0.12) COVID-19 deaths. Another study also using Veterans Affairs data with exact- and propensity-matching in a similar time period @ioannou2022a, unsurprisingly estimated similar results at 24 weeks for documented infection (1.73, 95%CI 1.50 to 1.96 additional events per 1,000 people in those with a BNT162b2 first dose compared with a mRNA-1273), COVID-19 hospitalisation (0.56, 95%CI 0.45 to 0.67) and COVID-19 death (0.03, 95%CI -0.00 to 0.07). Accounting for the longer follow-up period and statistical uncertainty, these estimates are consistent with our findings for comparative effectiveness of boosting.

A study in English data estimated the effectiveness of BNT162b2 boosting versus no boosting and mRNA-1273 boosting versus no boosting separately using a test-negative-control design @andrews2022, suggests marginally higher effectiveness against symptomatic disease in mRNA-1273 than in BNT162b2, but this assumes that the respective control populations in each analysis were similar.

The evidence therefore points strongly to a small benefit of mRNA-1273 over BNT162b2 for primary and subsequent booster doses. Though small, an additional 0.22 hospitalisations per 1,000 people becomes 100s or over 1,000 hospitalisations in England at a population level, depending on booster uptake and infection risk. This carries a substantial additional burden on healthcare resources both during the acute phase of disease and for those with longer-term consequences. However, [safety... better than no boosting....]

### Conclusions

COVID-19-related outcomes after booster vaccination with BNT162b2 or mRNA-1273 were rare, though the risk was slightly higher for BNT162b2 and for mRNA-1273. These finding were broadly consistent across subgroups. These are important differences at a population-level and may help inform vaccine procurement decisions for future booster programmes. Individuals should not defer booster vaccination by BNT162b2 in favour of waiting for mRNA-1273 if offered.


## IG / Funding / COI / etc

Statements to add

## Figures and tables

#### Table 1: inclusion criteria

```{r table-flowchart, echo=FALSE, warning=FALSE, message=FALSE}
match_flowchart %>%
  select(-crit) %>%
   pivot_wider(
    id_cols = c(criteria, vax3_type),
    names_from = vax3_type,
    values_from = c(n, n_exclude, pct_all, pct_step)
  ) %>%
  gt() %>%
  cols_label(
    criteria = "",
    
    n_pfizer = "N",
    n_moderna = "N",

    n_exclude_pfizer = "N excluded",
    n_exclude_moderna = "N excluded",
    
    pct_all_pfizer = "% (overall)",
    pct_all_moderna = "% (overall)",
    pct_step_pfizer = "% (incremental)",
    pct_step_moderna = "% (incremental)",
  ) %>%
  tab_spanner(
    label = "BNT162b2",
    columns = ends_with("pfizer")
  ) %>%
   tab_spanner(
    label = "Moderna mRNA-1273",
    columns = ends_with("moderna")
  ) %>%
  fmt_percent(
    columns = starts_with(c("pct_")),
    decimals = 1
  ) %>%
  fmt_number(
    columns = starts_with(c("n_")),
    decimals= 0
  ) %>%
  fmt_missing(
    everything(),
    missing_text="-"
  ) %>%
  tab_style(
    style=cell_text(whitespace ="pre-wrap"),
    #style=cell_text(style ="italic"),
    locations = cells_body(columns = "criteria")
  ) %>%
  tab_options(
    table.font.size = 8
  )

cat("  \n\n")
```

     

     

     


#### Table 2: baseline characteristics

```{r table-table1, echo=FALSE, warning=FALSE, message=FALSE}
table1A <- 
  matchA_table1 %>%
  filter(!is.na(`stat_1`)) %>%
  group_by(variable) %>%
  mutate(
    nlabel=n(),
    #label = if_else(row_number()==1, label, str_c("&nbsp;&nbsp;&nbsp;", label)),
    var_label = if_else(row_number()==1, var_label, ""),
    label = if_else(nlabel!=1, label, ""),
  ) %>%
  mutate(
    across(
      starts_with("stat_"),
      ~if_else(is.na(.x) & row_number()==1, "", .x)
    )
  ) %>%
  ungroup() %>%
  mutate(
    order = cumsum(lag(variable, 1, first(variable))!=variable)
  ) %>%
  select(
    variable, var_label, label, starts_with("stat_"), order
  ) %>%
  rename(!!!set_names(matchA_table1by$by_col, matchA_table1by$by_chr))


table1B <- 
  matchB_table1 %>%
  filter(!is.na(`stat_1`)) %>%
  group_by(variable) %>%
  mutate(
    nlabel=n(),
    #label = if_else(row_number()==1, label, str_c("&nbsp;&nbsp;&nbsp;", label)),
    var_label = if_else(row_number()==1, var_label, ""),
    label = if_else(nlabel!=1, label, ""),
  ) %>%
  mutate(
    across(
      starts_with("stat_"),
      ~if_else(is.na(.x) & row_number()==1, "", .x)
    )
  ) %>%
  ungroup() %>%
  mutate(
    order = cumsum(lag(variable, 1, first(variable))!=variable)
  ) %>%
  select(
    variable, var_label, label, starts_with("stat_"), order
  ) %>%
  rename(!!!set_names(matchB_table1by$by_col, matchB_table1by$by_chr))


table1 <- 
  left_join(
    table1A, table1B, by=c("variable", "var_label", "label", "order"),
    suffix=c("_A", "_B")
  ) 

table1B %>%
  gt() %>%
  fmt_markdown(columns = "label") %>%
  tab_style(
    style = list(
      cell_fill(color = "gray96")
    ),
    locations = cells_body(
      rows = order%%2 == 0
    )
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(everything())
  ) %>%
  cols_label(
    var_label = "Variable",
    #`BNT162b2_A` = "BNT162b2",
    #`Moderna mRNA-1273_A` = "mRNA-1273",
    `BNT162b2` = "BNT162b2",
    `Moderna mRNA-1273` = "mRNA-1273",
    label=md("Characteristic")
  ) %>%
  # tab_spanner(
  #   label = "Matching strategy A",
  #   columns = ends_with("_A")
  # ) %>%
  # tab_spanner(
  #   label = "Matching strategy B",
  #   columns = ends_with("_B")
  # ) %>%
  cols_align(
    align = c("right"),
    columns = (c("BNT162b2", "Moderna mRNA-1273"))
  ) %>%
  cols_hide(c("variable", "order")) %>%
  tab_options(
    table.font.size = 8
  )

cat("  \n\n")
```

     

     

     

#### Table 3: 12-week risk estimates

Counts and survival estimates are based on values rounded up to the nearest n\*6-3, for disclosure control.

```{r table-contrasts, echo=FALSE, warning=FALSE, message=FALSE}


contrasts_overall_table %>%
  filter(
    outcome %in% outcomes,
    strategy=="B"
  ) %>%
  group_by(outcome_descr) %>%
  select(
    outcome_descr,
    subgroup_descr,
    subgroup_level_descr,
    
    n.atrisk,
    
    persontime_0,
    persontime_1,
    
    n.event_0,
    n.event_1,
    
    riskCI_0,
    riskCI_1,
    
    cirdCI,
    #cirrCI,
    #kmirrCI,
    coxhrCI,
  ) %>%
  mutate(
    # add indicator for row shading
    shade = cumsum((lag(subgroup_descr, 1, "")!=subgroup_descr)*1L),
    # remove repeat values of subgroup_level
    subgroup_descr = if_else(lag(subgroup_descr)==subgroup_descr & row_number()!=1, "", as.character(subgroup_descr)),
  ) %>%
  ungroup() %>%
  gt(groupname_col="outcome_descr") %>%
  cols_label(
    
    outcome_descr = "Outcome",
    subgroup_descr = "Sub-group",
    subgroup_level_descr = "",
    
    n.atrisk = "N per group",
    
    persontime_0 = "Person-weeks", 
    persontime_1 = "Person-weeks", 
    
    n.event_0 = "Events",
    n.event_1 = "Events",
    
    riskCI_0 = glue("12-week risk per {perN_format} people (95% CI)"),
    riskCI_1 = glue("12-week risk per {perN_format} people (95% CI)"),
    
    cirdCI = glue("Risk difference per {perN_format} people (95% CI)"),
    #cirrCI = "Risk ratio (95% CI)",
    #kmirrCI = "Incidence rate ratio (95% CI)",
    coxhrCI = "Hazard ratio (95% CI)"
  ) %>%
  tab_spanner(
    label = "BNT162b2",
    columns = ends_with("_0")
  ) %>%
   tab_spanner(
    label = "Moderna",
    columns = ends_with("_1")
  )  %>%
   tab_spanner(
    label = "Comparison (reference=BNT162b2)",
    columns = ends_with("CI")
  ) %>%
  cols_align(
    align = c("right"),
    columns = ends_with(c("atrisk", "_1", "_0", "CI"))
  ) %>%
  tab_options(
    table.font.size = 8
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "gray96")
    ),
    locations = cells_body(
      rows = shade%%2 != 0
    )
  ) %>%
  cols_hide(c("shade"))
  
cat("  \n\n")
```





     

     

     



#### Figure 1: Cumulative numbers included in the matched sample

```{r, figure-matchingrates, echo=FALSE, message=FALSE, warning=FALSE, out.width='90%', out.height='50%', results='asis', out.extra=''}
#read_rds(fs::path(output_dir_os, "descriptive", "vaxdate", "plot_vaxdate_stack.rds"))

xmin <- min(match_coverage$vax3_date )
xmax <- max(match_coverage$vax3_date )+1


data_annotate <- tibble(
    vax3_date = date(c("2021-11-26", "2021-11-26", "2022-01-07", "2022-01-07")),
    cumuln = c(1000000, -2900000, 0, -2900000),
    label = c("mRNA-1273", "BNT162b2", "Matched", "Unmatched"),
    colour = c(brewer_pal(type="qual", palette="Set2")(2)[c(2,1)], "darkgrey", "grey"),
    vjust = c(1.2,-0.1,1.2,-0.1)
  )

plot_coverage_cumuln <-
  matchB_coverage %>%
  mutate(
   # treatment_descr = fct_recoderelevel(as.character(treatment), recoder$treatment),
    #status_descr = fct_rev(fct_recoderelevel(as.character(status), recoder$status)),
    #status_descr = fct_rev(status_descr),
    cumuln = cumulnB*((treatment*2) - 1)
  ) %>%
  ggplot()+
  geom_col(
    aes(
      x=vax3_date+0.5,
      y=cumuln,
      group=paste0(treatment,status_descr),
      fill=treatment_descr,
      alpha=status_descr,
      colour=NULL
    ),
    position=position_stack(reverse=TRUE),
    width=1
  )+
  geom_rect(xmin=xmin, xmax= xmax+1, ymin=-6, ymax=6, fill="grey", colour="transparent")+
  geom_text(data=data_annotate, aes(x=vax3_date, y=cumuln, label=label), colour=data_annotate$colour, vjust=data_annotate$vjust, hjust=1.05, fontface="bold")+
  scale_x_date(
    breaks = seq(xmin, xmax+1, by=14),
    #breaks = unique(lubridate::ceiling_date(match_coverage$vax3_date, "1 month")),
    limits = c(xmin-1, NA),
    labels = scales::label_date("%d/%m"),
    expand = expansion(add=1),
    sec.axis = sec_axis(
      trans = ~as.Date(.),
      breaks=as.Date(seq(floor_date(xmin, "month"), ceiling_date(xmax, "month"),by="month")),
      labels = scales::label_date("%B %y")
    )
  )+
  scale_y_continuous(
    labels = ~scales::label_number(accuracy = 1, big.mark=",")(abs(.)),
    expand = expansion(c(0, NA))
  )+
  scale_fill_brewer(type="qual", palette="Set2")+
  scale_colour_brewer(type="qual", palette="Set2")+
  scale_alpha_discrete(range= c(0.8,0.4))+
  labs(
    x="Date",
    y="Cumulative booster vaccines",
    colour=NULL,
    fill=NULL,
    alpha=NULL
  ) +
  theme_minimal()+
  theme(
    axis.line.x.bottom = element_line(),
    axis.text.x.top=element_text(hjust=0),
    strip.text.y.right = element_text(angle = 0),
    axis.ticks.x=element_line(),
    legend.position = "none",
    legend.box = "horizontal"
  )+
  NULL

plot_coverage_cumuln

cat("  \n\n")
```

     

     

     

```{r, function-ci, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%', out.height='50%', results='asis', out.extra=''}

ci_theme <- function(...) {
  theme(
      legend.position="none",
      axis.text.x.top=element_text(hjust=0),
      axis.line.y = element_line(colour = "black"),
      axis.line.x.top = element_line(colour = "black"),
      
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      strip.background = element_blank(),
      strip.text = element_blank(),
      strip.placement="outside",
      panel.border = element_blank(),
      panel.spacing = unit(0.8, "lines"),
      ...
    )
}

#colourvalues <- RColorBrewer::brewer.pal(10, "Paired")[c(1,2,5,6,3,4,7,8,9,10)]
colourvalues <- c("#D55E00", "#009E73", "#CC79A7", "#56B4E9", "#CC79A7", "#56B4E9", "#0072B2")

plot_ci_subgroup <- function(subgroup){
    
  subgroup0 <- subgroup
  
  if(subgroup=="all"){
    colour_guide <- list(guides(colour="none", fill="none", alpha="none"))
  } else{
    colour_guide <- list(guides(fill="none", alpha="none"))
  }
  
  plot_ci <- ci_estimates %>%
    filter(
      subgroup==subgroup0,
      outcome %in% outcomes
    ) %>%
    mutate(
      colgroup = interaction(treatment_descr, subgroup_level_descr, sep=", "),
      outcome_descr = fct_relabel(outcome_descr, str_wrap, width=10)
    ) %>%
    group_by(colgroup, outcome_descr) %>%
    mutate(
      lagrisk=lag(risk,1,0),
    ) %>%
    ggplot(aes(group=colgroup, colour=treatment_descr, fill=treatment_descr, alpha=treatment_descr)) +
    geom_hline(aes(yintercept=0), colour="black")+
    #geom_step(aes(x=lagtime, y=risk, linetype=treatment_descr))+
    geom_segment(aes(x=lagtime, xend=time, y=risk, yend=risk))+
    geom_segment(aes(x=lagtime, xend=lagtime, y=lagrisk, yend=risk))+
    geom_rect(aes(xmin=lagtime, xmax=time, ymin=risk.ll, ymax=risk.ul), alpha=0.1, colour="transparent")+
    facet_grid(rows=vars(outcome_descr), cols=vars(subgroup_level_descr), scales="free_y", switch="y")+
    scale_color_brewer(type="qual", palette="Set2", na.value="grey") +
    scale_fill_brewer(type="qual", palette="Set2", guide="none", na.value="grey") +
    #scale_color_manual(values=colourvalues, na.value="grey") +
    #scale_fill_manual(values=colourvalues, guide="none", na.value="grey") +
    scale_x_continuous(breaks = seq(0,600,14), expand = expansion(mult=c(0,0.01)))+
    scale_y_continuous(expand = expansion(mult=c(0,0.01)), label=label_number_risk)+
    scale_alpha_discrete(range=c(0.3,0.9))+
    coord_cartesian(xlim=c(0, NA))+
    labs(
      x="Days",
      y=NULL,
      title=glue("Cumulative incidence per {perN_format}"),
      colour=NULL,
      alpha=NULL,
      linetype=NULL
    )+
    guides(linetype="none", fill="none", alpha="none")+
    theme_minimal(base_size = 9)+
      theme(
        # legend.position = c(0.05,0.1),
        # legend.justification = c(0,0),
        legend.position = "bottom",
        #legend.direction = "vertical",
        axis.text.x.top=element_text(hjust=0),
  
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_blank(),
        strip.placement="outside",
        strip.text.y.left = element_text(angle=0),
  
        panel.border = element_blank(),
        panel.spacing = unit(0.8, "lines"),
  
      )+
      NULL
  
  
  
  
  plot_contrasts_data <- contrasts_daily %>%
    filter(
      subgroup==subgroup0,
      outcome %in% outcomes
    ) %>%
    group_by(subgroup_level_descr, outcome_descr) %>%
    mutate(
      outcome_descr = fct_relabel(outcome_descr, str_wrap, width=10),
      lagcird=lag(cird,1,0),
      lagcirr=lag(cirr,1,1)
    )
  
  plot_cirr <- 
    plot_contrasts_data %>%
    group_by(subgroup_level_descr, outcome_descr) %>%
    ggplot(aes(group=subgroup_level_descr)) +
    geom_hline(aes(yintercept=1), colour="black")+
    geom_segment(aes(x=period_start, xend=period_end, y=cirr, yend=cirr))+
    geom_segment(aes(x=period_start, xend=period_start, y=lagcirr, yend=cirr))+
    geom_rect(aes(xmin=period_start, xmax=period_end, ymin=cirr.ll, ymax=cirr.ul), alpha=0.1, colour="transparent")+
    facet_grid(rows=vars(outcome_descr), scales="free_y", switch="y")+
    #scale_color_brewer(type="qual", palette="Set1", na.value="grey") +
    #scale_fill_brewer(type="qual", palette="Set1", guide="none", na.value="grey") +
    scale_x_continuous(breaks = seq(0,600,14), expand = expansion(mult=c(0,0.01)))+
    scale_y_log10(expand = expansion(mult=c(0,0.01)))+
    coord_cartesian(xlim=c(0, NA))+
    labs(
      x="Days",
      y=NULL,
      title="Risk ratio",
      colour=NULL
    )+
    colour_guide+
    theme_minimal(base_size = 9)+
    theme(
      legend.position="none",
      axis.text.x.top=element_text(hjust=0),
      axis.line.y = element_line(colour = "black"),
      axis.line.x.top = element_line(colour = "black"),
      
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      strip.background = element_blank(),
      strip.text = element_blank(),
      strip.placement="outside",
      panel.border = element_blank(),
      panel.spacing = unit(0.8, "lines")
    )+
    NULL
  
  plot_coxhr <- contrasts_cuts %>%
    # equivalent to the hazard
    filter(
      subgroup==subgroup0,
      outcome %in% outcomes
    ) %>%
    group_by(outcome_descr, subgroup_level_descr) %>%
    ggplot(aes(group=subgroup_level_descr, colour=subgroup_level_descr, fill=subgroup_level_descr)) +
    geom_hline(aes(yintercept=1), colour="black")+
    geom_segment(aes(x=period_start, xend=period_end, y=coxhr, yend=coxhr))+
    geom_segment(aes(x=period_start, xend=period_start, y=lag(coxhr), yend=coxhr))+
    geom_rect(aes(xmin=period_start, xmax=period_end, ymin=coxhr.ll, ymax=coxhr.ul), alpha=0.1, colour="transparent")+
    facet_grid(rows=vars(outcome_descr), scales="free_y")+
    # scale_color_brewer(type="qual", palette="Set1", na.value="grey") +
    # scale_fill_brewer(type="qual", palette="Set1", guide="none", na.value="grey") +
    scale_color_manual(values=colourvalues, na.value="grey") +
    scale_fill_manual(values=colourvalues, guide="none", na.value="grey") +
    scale_x_continuous(breaks = seq(0,600,14), expand = expansion(mult=c(0,0.01)))+
    scale_y_log10(expand = expansion(mult=c(0,0.01)))+
    coord_cartesian(xlim=c(0, NA))+
    colour_guide+
    labs(
      x="Days",
      y="higher risk\n<- BNT162b2 | mRNA 1273 ->",
      title="Hazard ratio",
      colour=NULL
    )+
    theme_minimal(base_size = 9)+
    ci_theme()+
    NULL
  
  
  n_subgroups <-
    ci_estimates %>%
    filter(
      subgroup==subgroup0
    ) %>% 
    `[[`("subgroup_level_descr") %>%
    n_distinct()
  
  plot_combined <- patchwork::wrap_plots(
    plot_ci, 
    #plot_cird, 
    plot_cirr, 
    #plot_kmirr,
    #plot_coxhr,
    ncol=2,
    widths=c(n_subgroups,1)
  )
  
  ggsave(
    filename=glue("ciB_{subgroup}.png"),
    path=output_dir_rmd,
    plot=plot_combined,
  )

  plot_combined
}

```

#### Figure 2: Estimates of cumulative risk per `r perN_format` people

```{r, figure-ci-all, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%', out.height='50%', results='asis', out.extra=''}
plot_ci_subgroup("all")
```

     

     

     


\newpage

#### Figure 3a: 12-week risk difference by subgroups

```{r figure-contrasts-cird, echo=FALSE, warning=FALSE, message=FALSE}


contrasts_overall_plot <- 
  contrasts_overall %>%
  filter(
    outcome %in% outcomes,
    strategy=="B"
  ) %>%
  group_by(outcome_descr) %>%
  mutate(
    outcome_descr = fct_relabel(outcome_descr, str_wrap, width=10),
    subgroup_level_descr = fct_rev(subgroup_level_descr),
  )

contrasts_overall_plot %>%
  ggplot(aes(y=subgroup_level_descr)) +
  geom_vline(aes(xintercept=0), linetype="dotted", colour="darkgrey")+
  geom_point(aes(x=cird), position=position_dodge(width=-0.3))+
  geom_linerange(aes(xmin=cird.ll, xmax=cird.ul), position=position_dodge(width=-0.3))+
  facet_grid(rows=vars(subgroup_descr), cols=vars(outcome_descr), scales="free", space="free_y", switch="y")+
  scale_x_continuous(expand = expansion(mult=c(0,0.01)), label=label_number(0.1, perN, style_negative="minus", big.mark=","))+
  #scale_fill_brewer(type="qual", palette="Set2")+
  #scale_colour_brewer(type="qual", palette="Set2")+
  labs(
    x="12-week risk difference per 1,000 people\n <- favours mRNA-1273  |  favours BNT162b2 ->",
    y=NULL
  )+
  theme_minimal()+
  theme(
    legend.position="bottom",
    axis.text.x.top=element_text(hjust=0),
  
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_blank(),
    strip.placement="outside",
    #strip.text.y.left = element_text(angle=0),
    strip.text.y.left = element_blank(),
  
    panel.border = element_blank(),
    panel.spacing = unit(0.3, "lines"),
  )


cat("  \n\n")
```



#### Figure 3b: 12-week risk ratio by subgroups

```{r figure-contrasts-cirr, echo=FALSE, warning=FALSE, message=FALSE}


contrasts_overall_plot %>%
  ggplot(aes(y=subgroup_level_descr)) +
  geom_vline(aes(xintercept=1), linetype="dotted", colour="darkgrey")+
  geom_point(aes(x=cirr), position=position_dodge(width=-0.3))+
  geom_linerange(aes(xmin=cirr.ll, xmax=cirr.ul), position=position_dodge(width=-0.3))+
  
  facet_grid(rows=vars(subgroup_descr), cols=vars(outcome_descr), scales="free", space="free_y", switch="y")+
  scale_x_log10(label=label_number(0.1, style_negative="minus", big.mark=","), oob=oob_keep)+
  #scale_fill_brewer(type="qual", palette="Set2")+
  #scale_colour_brewer(type="qual", palette="Set2")+
  labs(
    x="12-week risk ratio\n <- favours mRNA-1273  |  favours BNT162b2 ->",
    y=NULL
  )+
  theme_minimal()+
  theme(
    legend.position="bottom",
    axis.text.x.top=element_text(hjust=0),
  
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_blank(),
    strip.placement="outside",
    #strip.text.y.left = element_text(angle=0),
    strip.text.y.left = element_blank(),
  
    panel.border = element_blank(),
    panel.spacing = unit(0.3, "lines"),
  )


cat("  \n\n")
```




#### Figure 3c: 12-week hazard ratio by subgroups

```{r figure-contrasts-coxhr, echo=FALSE, warning=FALSE, message=FALSE}


contrasts_overall_plot %>%
  ggplot(aes(y=subgroup_level_descr)) +
  geom_vline(aes(xintercept=1), linetype="dotted", colour="darkgrey")+
  geom_point(aes(x=coxhr), position=position_dodge(width=-0.3))+
  geom_linerange(aes(xmin=coxhr.ll, xmax=coxhr.ul), position=position_dodge(width=-0.3))+
  # note this is very similar to using ciirr or kmirr instead of coxhr
  facet_grid(rows=vars(subgroup_descr), cols=vars(outcome_descr), scales="free", space="free_y", switch="y")+
  scale_x_log10(label=label_number(0.1, style_negative="minus", big.mark=","), oob=oob_keep)+
  #scale_fill_brewer(type="qual", palette="Set2")+
  #scale_colour_brewer(type="qual", palette="Set2")+
  labs(
    x="12-week hazard ratio\n <- favours mRNA-1273  |  favours BNT162b2 ->",
    y=NULL
  )+
  theme_minimal()+
  theme(
    legend.position="bottom",
    axis.text.x.top=element_text(hjust=0),
  
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_blank(),
    strip.placement="outside",
    #strip.text.y.left = element_text(angle=0),
    strip.text.y.left = element_blank(),
  
    panel.border = element_blank(),
    panel.spacing = unit(0.3, "lines"),
  )


cat("  \n\n")
```

\newpage 

## References
