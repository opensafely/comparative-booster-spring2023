---
title: "Comparative safety and effectiveness of Pfizer BA.4-5 versus Sanofi during the spring 2023 COVID-19 booster vaccination programme in England: a matched cohort study in OpenSAFELY-TPP"
format:
  # html:
  #   toc: false
  #   embed-resources: true
  rtf
output-file: manuscript_draft.rtf
keep-md: false
execute:
  echo: false
  output: true
  #warning: true
knitr:
  opts_chunk: 
    #fig.path: ./
    fig.pos: H
    R.options:
      knitr.graphics.auto_pdf: true
bibliography: references.bib
csl: vancouver.csl
link-citations: true
zotero: true
---

```{r}
#| label: setup
#| include: false
#| warnings: false
#| cache: false
source(here::here("write-up", "manuscript", "setup.R"))
```

```{r}
#| label: process
#| include: false
#| cache: false
source(here("write-up", "manuscript", "import-process.R"))
```

TBD: Colm D Andrews^1^, Em Prestige^2^, Edward PK Parker^2^, Venexia Walker^3,4^, Tom Palmer^3,4^, Helen J Curtis^1^, Alex Walker^1^, Amir Mehrkar^1^, Brian MacKenna^1^, Sebastian CJ Bacon^1^, Ben Goldacre^1^, Miguel A HernÃ¡n^5,6^\*, Jonathan AC Sterne^3,7,8^\*, William J Hulme^1^, and the OpenSAFELY collaborative.

1\. The Bennett Institute for Applied Data Science, Nuffield Department of Primary Care Health Sciences, University of Oxford, OX26GG, UK

2\. London School of Hygiene and Tropical Medicine, Keppel Street, London, WC1E 7HT, UK

3\. Population Health Sciences, University of Bristol, Oakfield House, Oakfield Grove, Bristol, BS8 2BN, UK

4\. MRC Integrative Epidemiology Unit, Bristol Medical School, University of Bristol, Bristol, UK

5\. CAUSALab, Harvard T.H. Chan School of Public Health, Boston, MA 02115

6\. Departments of Epidemiology and Biostatistics, Harvard T.H. Chan School of Public Health, Boston, MA 02115

7\. NIHR Bristol Biomedical Research Centre, Bristol, UK

8\. Health Data Research UK South West

\newpage

## Abstract

*Introduction* The spring 2023 COVID-19 booster vaccination programme in England used both Pfizer BA.4-5 and Sanofi vaccines. All people aged 75 years or over and the clinically vulnerable were eligible to receive a booster dose. Direct comparisons of these two vaccines in boosting protection against severe COVID-19 events have not been made in trials or observational data.

*Methods* With the approval of NHS England, we used the OpenSAFELY-TPP database to compare effectiveness of the Pfizer BA.4-5 and Sanofi vaccines during the spring 2023 booster programme, between 1 April and 30 June 2023. We investigated two cohorts separately: those aged 75 or over (75+); and those aged 50 or over and clinically vulnerable (CV). In each cohort, vaccine recipients were matched on date of vaccination, COVID-19 vaccine history, age, and other characteristics. Effectiveness outcomes were COVID-19 hospital admission, COVID-19 critical care admission, and COVID-19 death up to 16 weeks after vaccination. Safety outcomes were pericarditis and myocarditis up to 4 weeks after vaccination. We report the cumulative incidence of each outcome, and compare safety and effectiveness using risk differences (RD), relative risks (RR), and incidence rate ratios (IRRs).

*Results* `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c5") %>% pull(n) %>% sum())` people were 1-1 matched in the CV cohort, and `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c5") %>% pull(n) %>% sum())` in the 75+ cohort, contributing a total `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(persontime_weeks)` and `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(persontime_weeks)` person-weeks of follow-up, respectively. The incidence of COVID-19 hospital admission was higher for Sanofi than for Pfizer BA.4-5. In the CV cohort, 16-week risks per `r perN_format` people were `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_0_95)` for Pfizer BA.4-5 and `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_1)` for Sanofi, with an IRR of `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(irrCI_95)`. In the 75+ cohort, these were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA.4-5 and `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_1)` for Sanofi, with an IRR of `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(irrCI)`. These finding were similar across all pre-specified subgroups. More severe COVID-19 related outcomes (critical care admission and death), and safety outcomes at 4 weeks, were rare in both vaccines so we could not reliably compare effectiveness of the two vaccines.
*Conclusion* This observational study comparing effectiveness of Pfizer BA.4-5 and Sanofi vaccine during the spring 2023 programme in England in the two main eligible cohorts -- people aged 75 and over and in clinically vulnerable people -- found some evidence of superior effectiveness against COVID-19 hospital admission for Pfizer BA.4-5 compared with Sanofi within 16 weeks after vaccination. Differences were largely observed during weeks 2 to 4 after vaccination, suggesting the Pfizer BA.4-5 offers earlier protection via more rapid immunogenicity, as shown in RCTs.

\newpage

````{comment}

````

## Background

The spring 2023 COVID-19 booster vaccination programme in England offered COVID-19 vaccination to those aged 75 years or over, resident in a care home, and those who are immunosuppressed, based on guidance from the Joint Committee for Vaccination and Immunisation (JCVI).[@NHSEnglandNHSc; @JCVIStatementCOVID19; @JCVIStatementSpring] Both the Pfizer BA.4-5 vaccine (authorised November 2022 [@SecondPfizerBioNTech]) and the Sanofi vaccine (authorised December 2022 [@SanofiPasteurCOVID19]) were used during this programme. This allows direct comparisons of their safety and effectiveness against severe COVID-19 disease - something not investigated in randomised trials.

We used the OpenSAFELY-TPP database, covering around 45% of English primary care practices and linked to hospital and death records, to compare safety and effectiveness of the Pfizer BA.4-5 and Sanofi vaccines received during the spring 2023 booster programme.

\newpage

## Methods

### Data source

All data were linked, stored and analysed securely using the OpenSAFELY platform: <https://opensafely.org/>, as part of the NHS England OpenSAFELY COVID-19 service. Data include pseudonymised data such as coded diagnoses, medications and physiological parameters. No free text data are included. All code is shared openly for review and re-use under MIT open license (<https://github.com/opensafely/comparative-booster-spring2023>). Detailed pseudonymised patient data is potentially re-identifiable and therefore not shared. Primary care records managed by the GP software provider, TPP were linked, using NHS numbers, to emergency department attendance and in-patient hospital spell records via NHS Digital's Hospital Episode Statistics (HES), national coronavirus testing records via the Second Generation Surveillance System (SGSS), and national death registry records from the Office for National Statistics (ONS). COVID-19 vaccination history and health and social care worker status is available in the GP record directly via the National Immunisation Management System (NIMS).

### Eligibility criteria

We considered two cohorts: all adults aged 75 years or over ("75+"), and all adults aged 50 or over who were considered clinically vulnerable ("CV"). These groups are not mutually exclusive. We only considered those aged 50 years or over because the Sanofi vaccine was rarely offered to younger people. Clinical vulnerability encompasses various chronic or immunosuppressive conditions and medications as set out in the Green Book chapter 14a @COVID19GreenBook, and defined in the supplementary materials.

In each group, any person receiving a Pfizer BA.4-5 or Sanofi vaccine dose between `r study_dates_format$studystart_date` and `r study_dates_format$studyend_date` inclusive was considered. People were eligible if they: were registered at a GP practice using TPP's SystmOne clinical information system at the time of vaccination; had received at least two prior COVID-19 vaccine doses; were not a health or social care worker and not receiving end-of-life care; had no evidence of SARS-CoV-2 infection or COVID-19 disease during the 28 days prior to vaccination; were not a hospital in-patient at the time of vaccination; and had complete information on sex, deprivation, and Sustainability and Transformation Partnership (STP, a geographical grouping of NHS and Local Authorities).

### Matching

Pfizer BA.4-5 and Sanofi vaccine recipients were matched 1-1 without replacement, on the following characteristics: date of vaccination (3-day caliper); number of previous COVID-19 vaccine doses (grouped as 2 to 4, 5, or 6 or more); time since previous COVID-19 vaccine dose (28-day caliper); sex (male or female); age (3-year caliper and within age groups 50-64, 65-75, 75-79, 80-84, 85+); Index of Multiple Deprivation (IMD, within a 5000 IMD-rank caliper); STP as a surrogate for geographical region; any evidence of prior SARS-CoV-2 infection (including any of: positive SARS-CoV-2 test, infection as documented in primary care, COVID-19 hospital attendance or admission); and morbidity count (grouped as 0, 1, or 2 or more conditions from the following list: diabetes, BMI over 40kg/m^2^, chronic heart disease, chronic kidney disease, chronic liver disease, chronic respiratory disease or severe asthma, chronic neurological disease, cancer within 3 years). Clinical vulnerability was an additional matching factor in the 75+ cohort.

Age was calculated as of 30 June 2023, to allow for a degree of operational flexibility in who was offered vaccination during the programme. All other characteristics were calculated as of the day before vaccination. In the analysis cohorts there are no missing values for any characteristics as people with missing values for sex, IMD or STP were excluded, and remaining characteristics were defined by the presence or absence of clinical codes or events in the health record. The supplementary materials provide more information on how these characteristics were defined.

### Outcomes and follow-up

We considered three effectiveness outcomes. COVID-19 hospital admission was identified using Secondary Use Service (SUS) in-patient hospital spell records with International Statistical Classification of Diseases and Related Health Problems 10th Revision (ICD-10) codes U07.1, U07.2, or U.109 as the primary or non-primary reason for admission. COVID-19 critical care admissions were any COVID-19 hospital spell with at least one day spent in critical care (including any such spells occurring subsequent to the first spell after vaccination). COVID-19 death was defined as COVID-19 ICD-10 codes (as before) mentioned anywhere on the death certificate (i.e., as an underlying or contributing cause of death). We also report on non-COVID-19 deaths.
We considered three effectiveness outcomes. COVID-19 hospital admission was identified using Secondary Use Service (SUS) in-patient hospital spell records with International Statistical Classification of Diseases and Related Health Problems 10th Revision (ICD-10) codes U07.1, U07.2, or U.109 as the primary or non-primary reason for admission. COVID-19 critical care admissions were any COVID-19 hospital spell with at least one day spent in critical care (including any such spells occurring subsequent to the first spell after vaccination). COVID-19 death was defined as COVID-19 ICD-10 codes (as before) mentioned anywhere on the death certificate (i.e., as an underlying or contributing cause of death). We also report on non-COVID-19 deaths.

We considered two safety outcomes. Pericarditis within 28 days of vaccination was identified using SUS emergency department records with pericarditis listed as the discharge diagnosis (SNOMED), and using ICD-10 coded hospital admission and death records. Myocarditis was identified similarly. Details of the codelists used to define these outcomes are available in the supplementary materials.

<!--# COVID-19 related attendance and critical/intensive care admission we also considered but there were doubts over data the reliability of event ascertainment in these cases. -->

Each person was followed from receipt of vaccination (time zero) until the outcome of interest, with censoring at death, practice de-registration, or `r study_dates_format$followupend_date`. Outcomes were observed for up to 16 weeks for effectiveness outcomes, and up to 4 weeks for safety outcomes.

### Statistical Analysis

Baseline characteristics of each vaccine group were tabulated, with between-group balance examined using standardised mean differences. We estimated the cumulative incidence of each outcome in each vaccine group using the Kaplan-Meier (KM) estimator. We estimated cumulative risk differences and risk ratios (RRs) comparing the vaccine groups for each outcome. We also estimated Incidence Rate Ratios (IRRs) for Sanofi versus Pfizer BA.4-5 recipients over the full follow-up duration, and within period-specific intervals defined by splits on weeks 1, 2, 4, 8, 12, and 16.

<!-- 95% confidence limits for the AJ estimates were derived from a Greenwood-type formula. Confidence limits for the risk difference were derived from the sum of squares of the AJ standard errors, derived from Greenwoodâs formula. Confidence limits for the survival ratio were based on the standard error of the cumulative hazard. Confidence limits for the risk ratio were derived using the Delta method. -->

95% confidence limits for the cumulative incidences were derived using standard errors on the log-KM scale. Confidence limits for the risk differences were derived from the sum of squares of the standard errors on the KM scale, using Greenwood's formula. Confidence limits for the risk ratios and incidence rate ratios were derived from the sum of squares of the standard errors on the log-KM scale. <!-- 95% confidence limits for the Kaplan-Meier estimates, risk differences, risk ratios, and incidence rate ratios are derived by bootstrapping the matched pairs. 500 bootstrap replicates will be used. -->

### Subgroup and secondary analyses

We estimated comparative effectiveness separately in the following subgroups: age band in the CV group only (50-64, 65-75, 75-79, 80-84, 85+); clinical vulnerability in the 75+ group only; prior COVID-19 vaccine count. We used $\chi^2$ tests to examine evidence for heterogeneity in estimates between subgroups.

<!-- We reported outcomes at one week as a negative control outcome @Lipsitch2010, during which time the vaccine is not expected to have any protective immunological effect. -->

### Disclosure control

To satisfy strict re-identification minimisation requirements for statistical outputs from OpenSAFELY's Trusted Research Environment, counts were rounded to the nearest 3, 9, 15, and so on. Plots of cumulative event counts and the Kaplan-Meier cumulative incidence estimates were rounded such that each increment is based on at least 6 events. Event rates, risk differences, and risk ratios were derived from these rounded estimates.

### Software, code, and reproducibility
Data management and analyses were conducted using OpenSAFELY tools, Python version 3.8.10 and R version 4.0.2. Code for data management and analysis, as well as codelists, are archived online (<https://github.com/opensafely/comparative-booster-spring2023>). Codelists are available at <https://www.opencodelists.org/>. The supplementary materials provide further details of codelists and data sources used for all variables in the study. Detailed pseudonymised patient data is potentially re-identifiable and therefore not shared. \newpage
## Results

````{comment}

````

### Study population and matching

We identified `r label_number(1, big.mark=",")(filter(flowchart_totals_allcohorts, boost_type=="any") %>% pull(n))` people aged 50 years or over who were recorded as having received a COVID-19 vaccine between `r study_dates_format$studystart_date` and `r study_dates_format$studyend_date` whilst registered at a TPP practice. This included `r label_number(1, big.mark=",")(filter(flowchart_totals_allcohorts, boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(flowchart_totals_allcohorts, boost_type=="pfizerBA45") %>% pull(pct))`) Pfizer BA.4-5 and `r label_number(1, big.mark=",")(filter(flowchart_totals_allcohorts, boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(flowchart_totals_allcohorts, boost_type=="sanofi") %>% pull(pct))`) Sanofi recipients.

We identified `r label_number(1, big.mark=",")(filter(rst$cv$flowchart_totals, boost_type=="any") %>% pull(n) %>% sum())` people in the CV cohort, and of these `r label_number(1, big.mark=",")(filter(rst$cv$flowchart_totals, boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart_totals, boost_type=="pfizerBA45") %>% pull(pct))`) received Pfizer BA.4-5 and `r label_number(1, big.mark=",")(filter(rst$cv$flowchart_totals, boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart_totals, boost_type=="sanofi") %>% pull(pct))`) received Sanofi, with `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(pct_all))`) and `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c4", boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c4", boost_type=="sanofi") %>% pull(pct_all))`) eligible for matching respectively (Figure 1a).
We identified `r label_number(1, big.mark=",")(filter(rst$cv$flowchart_totals, boost_type=="any") %>% pull(n) %>% sum())` people in the CV cohort, and of these `r label_number(1, big.mark=",")(filter(rst$cv$flowchart_totals, boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart_totals, boost_type=="pfizerBA45") %>% pull(pct))`) received Pfizer BA.4-5 and `r label_number(1, big.mark=",")(filter(rst$cv$flowchart_totals, boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart_totals, boost_type=="sanofi") %>% pull(pct))`) received Sanofi, with `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(pct_all))`) and `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c4", boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c4", boost_type=="sanofi") %>% pull(pct_all))`) eligible for matching respectively (Figure 1a).

`r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart_totals, boost_type=="any") %>% pull(n) %>% sum())` people were in the 75+ cohort, and of these `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart_totals, boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart_totals, boost_type=="pfizerBA45") %>% pull(pct))`) received Pfizer BA.4-5 and `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart_totals, boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart_totals, boost_type=="sanofi") %>% pull(pct))`) received Sanofi, with `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(pct_all))`) and `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c4", boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c4", boost_type=="sanofi") %>% pull(pct_all))`) eligible for matching respectively (Figure 1b).
`r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart_totals, boost_type=="any") %>% pull(n) %>% sum())` people were in the 75+ cohort, and of these `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart_totals, boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart_totals, boost_type=="pfizerBA45") %>% pull(pct))`) received Pfizer BA.4-5 and `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart_totals, boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart_totals, boost_type=="sanofi") %>% pull(pct))`) received Sanofi, with `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(pct_all))`) and `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c4", boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c4", boost_type=="sanofi") %>% pull(pct_all))`) eligible for matching respectively (Figure 1b).

Sanofi was more likely to be administered in April 2023, and Pfizer BA.4-5 more likely in May and June 2023. Prior to matching, Sanofi recipients were on average older, more likely to be recorded as resident in a care or nursing home, and less likely to have received fewer than 5 prior COVID-19 vaccine doses compared with Pfizer BA.4-5 recipients, in both cohorts. Sanofi recipients were less likely that Pfizer BA.4-5 recipients to have previously received the Pfizer/BA.1 vaccine during an earlier booster programme and more likely to have received Moderna/Omicron. Sex, deprivation levels, and ethnicity were similar in both groups prior to matching (supplementary Tables S1a and S1b).
In the CV cohort, `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c5", boost_type=="pfizerBA45") %>% pull(n))` people in each vaccine group (total `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c5", boost_type %in% c("pfizerBA45", "sanofi")) %>% pull(n) %>% sum())`) were matched, representing `r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c5", boost_type=="pfizerBA45") %>% pull(pct_step))` and `r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c5", boost_type=="sanofi") %>% pull(pct_step))` of eligible Pfizer and Sanofi recipients respectively (Figure 1a, Figure S1a). In the 75+ cohort, `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c5", boost_type=="pfizerBA45") %>% pull(n))` were matched in each vaccine group (total `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c5", boost_type %in% c("pfizerBA45", "sanofi")) %>% pull(n) %>% sum())`), representing `r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c5", boost_type=="pfizerBA45") %>% pull(pct_step))` and `r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c5", boost_type=="sanofi") %>% pull(pct_step))` of eligible Pfizer and Sanofi recipients respectively (Figure 1b, Figure S1b).

After matching, characteristics at the start of follow-up were well-balanced between groups (Table 1) with standardised mean differences consistently under 0.05 (supplementary Figures S2a and S2b), including for those characteristics not used for matching.


### Estimated comparative effectiveness

#### CV cohort

````{comment}
````{comment}

````
````

At 16 weeks there were `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(n.event)` COVID-19 hospital admissions, `r rst$cv$contrasts_table %>% filter(outcome=="covidcritcare", subgroup=="all") %>% pull(n.event)` COVID-19 critical care admissions, and `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(n.event)` COVID-19 deaths (Table 2).

The 16-week risks (cumulative incidence) per `r perN_format` people of COVID-19 hospital admissions were `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_0_95)` for those receiving Pfizer BA.4-5 and `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(rdCI_95)`) (Table 2; Figure 3). The corresponding 16-week risks per `r perN_format` people for COVID-19 critical care admission were `r rst$cv$contrasts_table %>% filter(outcome=="covidcritcare", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA.4-5 and `r rst$cv$contrasts_table %>% filter(outcome=="covidcritcare", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$cv$contrasts_table %>% filter(outcome=="covidcritcare", subgroup=="all") %>% pull(rdCI)` where values greater than zero favour Pfizer). The 16-week risks per `r perN_format` people of COVID-19 death were `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA.4-5 and `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(rdCI)`). For non-COVID-19 death, these were `r rst$cv$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA.4-5 and `r rst$cv$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$cv$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(rdCI)`).

IRRs (where values greater than one favour Pfizer) in the 16-week period after vaccination were `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(irrCI_95)` for COVID-19 hospital admissions, `r rst$cv$contrasts_table %>% filter(outcome=="covidcritcare", subgroup=="all") %>% pull(irrCI)` for COVID-19 critical care admission, `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(irrCI)` for COVID-19 death, and `r rst$cv$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(irrCI)` for non-COVID-19 death (Figure 4).

#### 75+ cohort

````{comment}

````

By 16 weeks there were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(n.event)` COVID-19 hospital admissions, `r rst$age75plus$contrasts_table %>% filter(outcome=="covidcritcare", subgroup=="all") %>% pull(n.event)` COVID-19 critical care admissions, and `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(n.event)` COVID-19 deaths (Table 2).

The 16-week risks (cumulative incidence) per `r perN_format` people of COVID-19 hospital admissions were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_0_95)` for those receiving Pfizer BA.4-5 and `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(rdCI_95)`) (Table 2; Figure 3). The corresponding 16-week risks per `r perN_format` people for COVID-19 critical care admission were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidcritcare", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA.4-5 and `r rst$age75plus$contrasts_table %>% filter(outcome=="covidcritcare", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$age75plus$contrasts_table %>% filter(outcome=="covidcritcare", subgroup=="all") %>% pull(rdCI)`). The 16-week risks per `r perN_format` people of COVID-19 death were `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA.4-5 and `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(rdCI)`). For non-COVID-19 death, these were `r rst$age75plus$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA.4-5 and `r rst$age75plus$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$age75plus$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(rdCI)`).

IRRs in the 16-week period after vaccination were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(irrCI_95)` for COVID-19 hospital admission, `r rst$age75plus$contrasts_table %>% filter(outcome=="covidcritcare", subgroup=="all") %>% pull(irrCI)` for COVID-19 critical care admission, `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(irrCI)` for COVID-19 death, and `r rst$age75plus$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(irrCI)` for non-COVID-19 death (Figure 3).
IRRs in the 16-week period after vaccination were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(irrCI_95)` for COVID-19 hospital admission, `r rst$age75plus$contrasts_table %>% filter(outcome=="covidcritcare", subgroup=="all") %>% pull(irrCI)` for COVID-19 critical care admission, `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(irrCI)` for COVID-19 death, and `r rst$age75plus$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(irrCI)` for non-COVID-19 death (Figure 3).

During the first week after vaccination event rates were similar between vaccine groups: the estimated HR was `r rst$age75plus$contrasts_cuts_table %>% filter(outcome=="covidadmitted", subgroup=="all", fup_start==0, fup_end==7) %>% pull(irrCI_95)` for COVID-19 hospital admissions, and `r rst$age75plus$contrasts_cuts_table %>% filter(outcome=="noncoviddeath", subgroup=="all", fup_start==0, fup_end==7) %>% pull(irrCI)` for non-COVID-19 death. COVID-19 critical care admission and COVID-19 deaths were rare so Hazard Ratios could not be reliably estimated.

Period-specific IRRs show that, in both cohorts during the first week after vaccination, event rates were similar between vaccine groups across all effectiveness outcomes (Supplementary Figure S4).

### Estimated comparative safety

In the CV cohort, there were `r rst$cv$contrasts_table %>% filter(outcome=="pericarditis", subgroup=="all") %>% pull(n.event_0)` and `r rst$cv$contrasts_table %>% filter(outcome=="pericarditis", subgroup=="all") %>% pull(n.event_1)` pericarditis events within 4 weeks after vaccination for Pfizer BA.4-5 and Sanofi recipients, respectively. This corresponded to a cumulative incidence per `r perN_format` people of `r rst$cv$contrasts_table %>% filter(outcome=="pericarditis", subgroup=="all") %>% pull(riskCI_0_95)` for Pfizer BA.4-5 and `r rst$cv$contrasts_table %>% filter(outcome=="pericarditis", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$cv$contrasts_table %>% filter(outcome=="pericarditis", subgroup=="all") %>% pull(rdCI_95)`). For myocarditis, there were `r rst$cv$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(n.event_0)` events for Pfizer BA.4-5 and `r rst$cv$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(n.event_1)` events for Sanofi (risk difference `r rst$cv$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(rdCI_95)`)

<!-- with a cumulative incidence of `r rst$cv$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(risk_0)` for Pfizer BA.4-5 and `r rst$cv$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(riskCI_1)` (0 to 0) for Sanofi (risk difference `r rst$cv$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(rdCI_95)`). -->

In the 75+ cohort, `r rst$age75plus$contrasts_table %>% filter(outcome=="pericarditis", subgroup=="all") %>% pull(n.event_0)` and `r rst$age75plus$contrasts_table %>% filter(outcome=="pericarditis", subgroup=="all") %>% pull(n.event_1)` pericarditis events within 4 weeks after vaccination for Pfizer BA.4-5 and Sanofi recipients, respectively, with a cumulative incidence per `r perN_format` people of `r rst$age75plus$contrasts_table %>% filter(outcome=="pericarditis", subgroup=="all") %>% pull(riskCI_0_95)` for those receiving Pfizer BA.4-5 and `r rst$age75plus$contrasts_table %>% filter(outcome=="pericarditis", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$age75plus$contrasts_table %>% filter(outcome=="pericarditis", subgroup=="all") %>% pull(rdCI_95)`). For myocarditis, there were `r rst$age75plus$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(n.event_0)` events for Pfizer BA.4/5 and `r rst$age75plus$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(n.event_1)` events for Sanofi (risk difference `r rst$age75plus$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(rdCI_95)`).

<!-- with a cumulative incidence of `r rst$age75plus$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(risk_0)` (95%CI 0-0) for Pfizer BA.4-5 and `r rst$age75plus$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$age75plus$contrasts_table %>% filter(outcome=="myocarditis", subgroup=="all") %>% pull(rdCI_95)`). -->

### Subgroup analyses

Findings in the main analyses were similar when examining subgroups, although estimated with reduced precision. The Supplementary materials provide cumulative incidence plots by subgroup (Figures S3), the corresponding cumulative risk differences, cumulative risk ratios, and period-specific IRRs (Figures S4), and subgroup-specific heterogeneity tests for risk differences and risk ratios (Table S2).


## Discussion

This observational study of COVID-19 vaccine recipients during the spring 2023 booster programme in England is, to our knowledge, the first to directly compare the Pfizer BA.4-5 and Sanofi vaccines for safety and effectiveness against severe COVID-19 outcomes. We estimated that, in both CV (N=`r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c5", boost_type %in% c("pfizerBA45", "sanofi")) %>% pull(n) %>% sum())` people) and 75+ (N=`r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c5", boost_type %in% c("pfizerBA45", "sanofi")) %>% pull(n) %>% sum())` people) cohorts, COVID-19 related hospital admissions were less frequent in those receiving the Pfizer BA.4-5 vaccine compared with Sanofi during the first 16 weeks after vaccination. For the more severe COVID-19 outcomes of critical care admission and death, there were very few events resultng in reduced power to identify differences between vaccines.

### Strengths and limitations

The OpenSAFELY-TPP database covers around 45% of the English population and contains rich clinical information which enabled us to closely match Pfizer BA.4-5 and Sanofi recipients to control for potential confounding and compare safety and effectiveness.

To make fair comparisons between the two vaccine types, we exploited the concurrent roll-out of both vaccines across the same eligible population during the same time period. We used 1-1 matching to control for potential differences in the distribution of prognostic factors between the two vaccine groups, and although this led to the omission of a substantial number of people from the final analysis, characteristics were very well-balanced after matching.

As an observational study, we cannot rule out residual confounding, though this is less problematic in comparative effectiveness studies than in studies comparing vaccinated with unvaccinated people, as all people entering the study have sought and received a booster vaccine.

We excluded groups who were unlikely to undergo boosting such as those in palliative care. We also excluded those identified as health and social care workers due to these groups being much more likely to receive their vaccines at their place of work, rather than at walk-in or bookable community vaccination centres, which may introduce bias. For example, occupation type for health care workers may influence both vaccine administration setting (and therefore vaccine type) and risk of infection.

This study does not include anyone who received the Moderna mRNA-1273 vaccine which was also available during the spring 2023 booster programme but was administered much more infrequently.

### Findings in context

<!-- The MHRA authorisation for Sanofi was based on clinical data from about 800 individuals previously immunised with an mRNA or viral-vectored vaccine \[@SanofiPasteurCOVID19\] and authorisation for Pfizer BA.4/BA.5 was based on a placebo-controlled efficacy trial, finding efficacy of 86 to 100% against laboratory-confirmed COVID-19. [@zouNeutralizationBABA2023] -->
Out-of-trial evidence of the effectiveness of Sanofi and Pfizer BA.4-5 vaccines against hospitalisation amongst adults aged 75 years and older in England from a test-negative case control study involving 14,174 eligible tests found similar effectiveness of both Pfizer BA.4-5 and Sanofi of 30-50%.[@kirsebomEffectivenessAdjuvantedSanofi2023] We are aware of no other planned or published randomised trials making direct endpoint comparisons of boosting with Pfizer BA.4-5 and Sanofi. 
### Conclusions

During the spring 2023 COVID-19 booster programme in England, COVID-19-related hospital admissions were slightly more frequent following receipt of the Sanofi vaccine than the Pfizer BA.4-5 vaccine after matching on a number of important potential confounders. These findings were broadly consistent across subgroups, though estimated with less precision.

\newpage

## Contributions

Conceptualization: WJH, EPKP, VW, TP, BG, MAH, and JACS. Data curation: WJH, CDA, EP, CW, BS, HJC, AW, AM, BM, and SCJB. Formal analysis: WJH, CDA, and VW. Funding acquisition: BG, and JACS. Methodology: WJH, EPKP, VW, TP, MAH, and JACS. Project administration: WJH, CDA, AM, BG,, and JACS. Resources: WJH, CDA, HJC, AW, AM, BM, BS, SCJB, and BG. Software: WJH, CDA, EP,  EPKP, BS, and SCJB. Supervision: WJH and JACS. Validation: WJH, EP, EPKP, CDA, CW, and VW. Visualization: WJH, CDA, and EPKP. Writing - original draft: WJH. Writing - review & editing: WJH, CDA, EPKP, VW, TP, HJC, AW, AM, BM, SCJB, BG, MAH, and JACS.

## Information governance and ethical approval

NHS England is the data controller for the NHS England OpenSAFELY COVID-19 Service; TPP is the data processor; all study authors using OpenSAFELY have the approval of NHS England @NHSEnglandOpenSAFELY. This implementation of OpenSAFELY is hosted within the TPP environment which is accredited to the ISO 27001 information security standard and is NHS IG Toolkit compliant @datasec.

Patient data has been pseudonymised for analysis and linkage using industry standard cryptographic hashing techniques; all pseudonymised datasets transmitted for linkage onto OpenSAFELY are encrypted; access to the NHS England OpenSAFELY COVID-19 service is via a virtual private network (VPN) connection; the researchers hold contracts with NHS England and only access the platform to initiate database queries and statistical models; all database activity is logged; only aggregate statistical outputs leave the platform environment following best practice for anonymisation of results such as statistical disclosure control for low cell counts @isb1523.

The service adheres to the obligations of the UK General Data Protection Regulation (UK GDPR) and the Data Protection Act 2018. The service previously operated under notices initially issued in February 2020 by the Secretary of State under Regulation 3(4) of the Health Service (Control of Patient Information) Regulations 2002 (COPI Regulations), which required organisations to process confidential patient information for COVID-19 purposes; this set aside the requirement for patient consent @WithdrawnWithdrawnCoronavirus2022. As of 1 July 2023, the Secretary of State has requested that NHS England continue to operate the Service under the COVID-19 Directions 2020 @COVID19PublicHealth. In some cases of data sharing, the common law duty of confidence is met using, for example, patient consent or support from the Health Research Authority Confidentiality Advisory Group @ConfidentialityAdvisoryGroup.

Taken together, these provide the legal bases to link patient datasets using the service. GP practices, which provide access to the primary care data, are required to share relevant health information to support the public health response to the pandemic, and have been informed of how the service operates.

This study was approved by the Health Research Authority (REC reference 20/LO/0651) and by London School of Hygiene and Tropical Medicine Ethics Board (reference 21863).

## Data access and verification

Access to the underlying identifiable and potentially re-identifiable pseudonymised electronic health record data is tightly governed by various legislative and regulatory frameworks, and restricted by best practice. The data in the NHS England OpenSAFELY COVID-19 service is drawn from General Practice data across England where TPP is the data processor.

TPP developers initiate an automated process to create pseudonymised records in the core OpenSAFELY database, which are copies of key structured data tables in the identifiable records. These pseudonymised records are linked onto key external data resources that have also been pseudonymised via SHA-512 one-way hashing of NHS numbers using a shared salt. University of Oxford, Bennett Institute for Applied Data Science developers and PIs, who hold contracts with NHS England, have access to the OpenSAFELY pseudonymised data tables to develop the OpenSAFELY tools.

These tools in turn enable researchers with OpenSAFELY data access agreements to write and execute code for data management and data analysis without direct access to the underlying raw pseudonymised patient data, and to review the outputs of this code. All code for the full data management pipeline --- from raw data to completed results for this analysis --- and for the OpenSAFELY platform as a whole is available for review at www.github.com/OpenSAFELY.

## Funding

This work was jointly funded by UKRI \(COV0076;MR/V015737/1\), the Longitudinal Health and Wellbeing strand of the National Core Studies programme (MC_PC_20030; MC_PC_20059; COV-LT-0009), NIHR and Asthma UK-BLF. The OpenSAFELY data science platform is funded by the Wellcome Trust (222097/Z/20/Z) and MRC (MR/V015737/1, MC_PC_20059, MR/W016729/1). In addition, development of OpenSAFELY has been funded by the the NIHR funded CONVALESCENCE programme (COV-LT-0009), NIHR (NIHR135559, COV-LT2-0073), and the Data and Connectivity National Core Study funded by UK Research and Innovation (MC_PC_20058) and Health Data Research UK (HDRUK2021.000).

BG's work on better use of data in healthcare more broadly is currently funded in part by: the Bennett Foundation, the Wellcome Trust, NIHR Oxford Biomedical Research Centre, NIHR Applied Research Collaboration Oxford and Thames Valley, the Mohn-Westlake Foundation; all Bennett Institute staff are supported by BG's grants on this work. EW holds grants from MRC. RHK was funded by UK Research and Innovation (Future Leaders Fellowship MR/S017968/1).

The views expressed are those of the authors and not necessarily those of the NIHR, NHS England, UK Health Security Agency (UKHSA) or the Department of Health and Social Care.

Funders had no role in the study design, collection, analysis, and interpretation of data; in the writing of the report; and in the decision to submit the article for publication.

For the purpose of Open Access, the author has applied a CC BY public copyright licence to any Author Accepted Manuscript (AAM) version arising from this submission.

## Conflicts of Interest

BG has received research funding from the Bennett Foundation, the Laura and John Arnold Foundation, the NHS National Institute for Health Research (NIHR), the NIHR School of Primary Care Research, NHS England, the NIHR Oxford Biomedical Research Centre, the Mohn-Westlake Foundation, NIHR Applied Research Collaboration Oxford and Thames Valley, the Wellcome Trust, the Good Thinking Foundation, Health Data Research UK, the Health Foundation, the World Health Organisation, UKRI MRC, Asthma UK, the British Lung Foundation, and the Longitudinal Health and Wellbeing strand of the National Core Studies programme; he has previously been a Non-Executive Director at NHS Digital; he also receives personal income from speaking and writing for lay audiences on the misuse of science. BMK is also employed by NHS England working on medicines policy and clinical lead for primary care medicines data.


## Patient and Public Involvement and Engagement (PPIE)

OpenSAFELY has developed a publicly available website https://www.opensafely.org/ through which they invite any patient or member of the public to make contact regarding the broader OpenSAFELY project.

## Acknowledgements

We are very grateful for all the support received from the TPP Technical Operations team throughout this work, and for generous assistance from the information governance and database teams at NHS England and the NHS England Transformation Directorate.

## Figures and tables

#### Table 1: Baseline characteristics before and after matching

```{r table-table1}
#| echo: false
#| warning: false

match_table1_wide_wide <-
  match_table1_wide %>%
  filter(
    matchset!="prematch",
    !(variable  %in% c("N", "immunosuppressed", "region"))
  ) %>%
  mutate(
    smd = if_else(variable %in% c(matching_variables$B$exact), NA_character_, smd)
  ) %>%
  pivot_wider(
    id_cols = c(var_label, variable, variable_levels, level),
    names_from = cohort,
    values_from = c(stat_0, stat_1, smd)
  ) %>%
  mutate(
    order_var = cumsum(lag(variable, 1, first(variable))!=variable)
  )

tab1 <-
  match_table1_wide_wide %>%
  gt(
    groupname_col = "var_label"
  ) %>%
  fmt_markdown(columns = "var_label") %>%
  tab_style(
    style = list(
      cell_fill(color = "gray96")
    ),
    locations = cells_body(
      rows = order_var%%2 == 0
    )
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(everything())
  ) %>%
  cols_label(
    var_label = "Variable",
    variable_levels = "",
    `stat_0_cv` = glue("Pfizer BA.4-5 (N={filter(match_table1, matchset=='postmatch', cohort=='cv', variable=='N', by==0) %>% pull(n)})"),
    `stat_1_cv` = glue("Sanofi (N={filter(match_table1, matchset=='postmatch', cohort=='cv', variable=='N', by==1) %>% pull(n)})"),
   `smd_cv` = "SMD",
    `stat_0_age75plus` = glue("Pfizer BA.4-5 (N={filter(match_table1, matchset=='postmatch', cohort=='age75plus', variable=='N', by==0) %>% pull(n)})"),
    `stat_1_age75plus` = glue("Sanofi (N={filter(match_table1, matchset=='postmatch', cohort=='age75plus', variable=='N', by==1) %>% pull(n)})"),
    `smd_age75plus` = "SMD"
  ) %>%
  sub_missing(
      columns = starts_with("smd_"),
      missing_text = "-"
  ) %>%
  tab_spanner(
    label = "CV",
    columns = ends_with("_cv")
  ) %>%
  tab_spanner(
    label = "75+",
    columns = ends_with("_age75plus")
  ) %>%
  cols_align(
    align = c("right"),
    columns =  ends_with(c("_cv", "_age75plus"))
  ) %>%
  cols_hide(c(
    "variable", "level", "order_var",
    #"smd_cv", "smd_age75plus",
    NULL
    )) %>% 
  tab_options(
    table.font.size = 8,
    row_group.as_column = TRUE
  )


gtsave(tab1, fs::path(output_dir_qmd, "table1.html"))

tab1

cat("  \n\n")
```

Standardised mean differences reported as "-" indicate that the variable was exactly matched on and is therefore zero by design.

All values are counts and percentages, except where "\*" indicates means and standard deviations.

#### Table 2: Estimates at 16-week follow-up of risk per `r perN_format` people in each vaccine group, and corresponding risk differences, overall and within subgroups

Counts and survival estimates are based on values rounded up to the nearest $6n-3$ for disclosure control.

```{r table-contrasts}
#| echo: false
#| warning: false

tabcontrasts <- 
  contrasts_table %>%
  filter(
    outcome %in% outcomes,
    subgroup == "all"
  ) %>%
  group_by(outcome_descr) %>%
  select(
    cohort_descr,
    outcome_descr,
    
    #n.atrisk,
    
    persontime_0,
    persontime_1,
    
    n.event_0,
    n.event_1,
    
    riskCI_0,
    riskCI_1,
    
    rdCI,
    rrCI,
    irrCI

  ) %>%
  mutate(
    # add indicator for row shading
    shade = cumsum((lag(as.character(outcome_descr), 1, "")!=outcome_descr)*1L),
    # remove repeat values of subgroup_level
    #subgroup_descr = if_else(lag(as.character(subgroup_descr),n=1,default="")==subgroup_descr, "", as.character(subgroup_descr)),
  ) %>%
  ungroup() %>%
  gt(groupname_col="cohort_descr") %>%
  cols_label(
    cohort_descr = "Cohort",
    outcome_descr = "Outcome",
    
    #n.atrisk = "N per group",
    
    persontime_0 = "Person-weeks", 
    persontime_1 = "Person-weeks", 
    
    n.event_0 = "Events",
    n.event_1 = "Events",
    
    riskCI_0 = glue("Risk per {perN_format} people (95% CI)"),
    riskCI_1 = glue("Risk per {perN_format} people (95% CI)"),
    
    rdCI = glue("Risk difference per {perN_format} people (95% CI)"),
    rrCI = "Risk ratio (95% CI)",
    irrCI = "Incidence rate ratio (95% CI)"
  ) %>%
  tab_spanner(
    label = "Pfizer BA.4-5",
    columns = ends_with("_0")
  ) %>%
   tab_spanner(
    label = "Sanofi",
    columns = ends_with("_1")
  )  %>%
   tab_spanner(
    label = "Comparison (reference = Pfizer BA.4-5)",
    columns = ends_with("CI")
  ) %>%
  cols_align(
    align = c("right"),
    columns = ends_with(c("atrisk", "_1", "_0", "CI"))
  ) %>%
  tab_options(
    table.font.size = 8
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "gray96")
    ),
    locations = cells_body(
      rows = shade%%2 != 0
    )
  ) %>%
  cols_hide(c("shade"))
  

gtsave(tabcontrasts, fs::path(output_dir_qmd, "tabcontrasts.html"))

tabcontrasts

cat("  \n\n")
```

#### Figure 1a: Flow of participants into the CV cohort
#### Figure 1a: Flow of participants into the CV cohort

![figure1a](figures_manual/flowchart_cv.png){width="60%"}
![figure1a](figures_manual/flowchart_cv.png){width="60%"}

#### Figure 1b: Flow of participants into the 75+ cohort
#### Figure 1b: Flow of participants into the 75+ cohort

![figure1b](figures_manual/flowchart_age75plus.png){width="40%"}


Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

```{r}
#| label: function-ci
#| warning: false
#| warning: false
#| out.width: '100%'
#| out.height: '50%'

#colourvalues <- RColorBrewer::brewer.pal(10, "Paired")[c(1,2,5,6,3,4,7,8,9,10)]
colourvalues <- c("#D55E00", "#009E73", "#CC79A7", "#56B4E9", "#CC79A7", "#56B4E9", "#0072B2")

plot_subgroup <- function(cohort, subgroup){
    
  subgroup0 <- subgroup
  
  if(subgroup=="all"){
    colour_guide <- list(guides(colour="none", fill="none", alpha="none"))
  } else{
    colour_guide <- list(guides(fill="none", alpha="none"))
  }
  

  plot_ci <- rst[[cohort]]$estimates %>%
    filter(
      subgroup==subgroup0,
      outcome %in% outcomes,
    ) %>%
    mutate(
      treatment_descr = fct_recode(treatment_descr, "pfizerBA45"="Pfizer BA.4-5", "sanofi"="Sanofi"),
      colgroup = interaction(treatment_descr, subgroup_level_descr, sep=", "),
      outcome_descr = fct_relabel(outcome_descr, str_wrap, width=10)
    ) %>%
    group_by(colgroup, outcome_descr) %>%
    mutate(
      risk = if_else(outcome=="covidadmitted" & time>20*7, NA_real_, risk),
      risk.ll = if_else(outcome=="covidadmitted" & time>20*7, NA_real_, risk.ll),
      risk.ul = if_else(outcome=="covidadmitted" & time>20*7, NA_real_, risk.ul),
      lagrisk = lag(risk,1,0),
    ) %>%
    ggplot(aes(group=colgroup, colour=treatment_descr, fill=treatment_descr, alpha=treatment_descr)) +
    geom_hline(aes(yintercept=0), colour="darkgrey")+
    #geom_step(aes(x=lagtime, y=risk*perN, linetype=treatment_descr))+
    geom_segment(aes(x=lagtime, xend=time, y=risk*perN, yend=risk*perN))+
    geom_segment(aes(x=lagtime, xend=lagtime, y=lagrisk*perN, yend=risk*perN))+
    geom_rect(aes(xmin=lagtime, xmax=time, ymin=risk.ll*perN, ymax=risk.ul*perN), alpha=0.1, colour="transparent")+
    facet_grid(rows=vars(outcome_descr), cols=vars(subgroup_level_descr), scales="free_y", switch="y")+
    scale_color_brewer(type="qual", palette="Set2", na.value="grey") +
    scale_fill_brewer(type="qual", palette="Set2", guide="none", na.value="grey") +
    #scale_color_manual(values=colourvalues, na.value="grey") +
    #scale_fill_manual(values=colourvalues, guide="none", na.value="grey") +
    scale_x_continuous(breaks = seq(0,600,28), expand = expansion(mult=c(0,0.01)), label = label_number(1, 1/7))+
    scale_y_continuous(
      expand = expansion(mult=c(0,0.01)), 
      #label=label_number_risk
    )+
    scale_alpha_discrete(range=c(0.3,0.9))+
    coord_cartesian(xlim=c(0, NA))+
    labs(
      x="Weeks",
      y=NULL,
      #title=glue("Cumulative incidence per {perN_format}"),
      colour=NULL,
      alpha=NULL,
      linetype=NULL
    )+
    guides(linetype="none", fill="none", alpha="none")+
    theme_minimal(base_size = 9)+
      theme(
        # legend.position = c(0.05,0.1),
        # legend.justification = c(0,0),
        legend.position = "bottom",
        #legend.direction = "vertical",
        axis.text.x.top=element_text(hjust=0),
  
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_blank(),
        strip.placement="outside",
        strip.text.y.left = element_text(angle=0),
  
        panel.border = element_blank(),
        panel.spacing = unit(0.8, "lines"),
  
      )+
      NULL
  
  
  
  
  plot_contrasts_data <- rst[[cohort]]$contrasts_daily %>%
    filter(
      subgroup==subgroup0,
      outcome %in% outcomes
    ) %>%
    group_by(subgroup_level_descr, outcome_descr) %>%
    mutate(
      outcome_descr = fct_relabel(outcome_descr, str_wrap, width=10),
      # remove values before 7 days to avoid infinite ratios before both groups have events
      #rr = if_else(fup_start<7, NA_real_, rr),
      #rr.ll = if_else(fup_start<7, NA_real_, rr.ll),
      #rr.ul = if_else(fup_start<7, NA_real_, rr.ul),
      lagrd=lag(rd,1,0),
      lagrr=lag(rr,1,1),
      
    )
  
  plot_rr <- 
    plot_contrasts_data %>%
    group_by(subgroup_level_descr, outcome_descr) %>%
    ggplot(aes(group=subgroup_level_descr)) +
    geom_hline(aes(yintercept=1), colour="darkgrey")+
    geom_segment(aes(x=fup_start, xend=fup_end, y=rr, yend=rr))+
    geom_segment(aes(x=fup_start, xend=fup_start, y=lagrr, yend=rr))+
    geom_rect(aes(xmin=fup_start, xmax=fup_end, ymin=rr.ll, ymax=rr.ul), alpha=0.1, colour="transparent")+
    facet_grid(rows=vars(outcome_descr), scales="free_y", switch="y")+
    #scale_color_brewer(type="qual", palette="Set1", na.value="grey") +
    #scale_fill_brewer(type="qual", palette="Set1", guide="none", na.value="grey") +
    scale_x_continuous(breaks = seq(0,600,28), expand = expansion(mult=c(0,0.01)), label = label_number(1, 1/7))+
    scale_y_log10(
      expand = expansion(mult=c(0,0.01)),
      label=label_number_rr,
      sec.axis = dup_axis(breaks=NULL, labels=NULL, name = "higher risk\n<- BNT162b2 | mRNA 1273 ->")
    )+
    coord_cartesian(xlim=c(0, NA))+
    labs(
      x="Weeks",
      y=NULL,
      title="Cumulative risk ratio",
      colour=NULL
    )+
    #colour_guide+
    theme_minimal(base_size = 9)+
    theme(
      legend.position="none",
      axis.text.x.top=element_text(hjust=0),
      #axis.line.y = element_line(colour = "darkgrey"),
      #axis.line.x.top = element_line(colour = "darkgrey"),

      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      strip.background = element_blank(),
      strip.text = element_blank(),
      strip.placement="outside",
      panel.border = element_blank(),
      panel.spacing = unit(0.8, "lines")
    )+
    NULL
  
  plot_irr <- rst[[cohort]]$contrasts_cuts %>%
    # equivalent(ish) to the hazard
    filter(
      subgroup==subgroup0,
      outcome %in% outcomes
    ) %>%
    group_by(outcome_descr, subgroup_level_descr) %>%
    ggplot(aes(group=subgroup_level_descr, colour=subgroup_level_descr, fill=subgroup_level_descr)) +
    geom_hline(aes(yintercept=1), colour="darkgrey")+
    geom_segment(aes(x=fup_start, xend=fup_end, y=irr, yend=irr))+
    geom_segment(aes(x=fup_start, xend=fup_start, y=lag(irr), yend=irr))+
    geom_rect(aes(xmin=fup_start, xmax=fup_end, ymin=irr.ll, ymax=irr.ul), alpha=0.1, colour="transparent")+
    facet_grid(rows=vars(outcome_descr), scales="free_y")+
    # scale_color_brewer(type="qual", palette="Set1", na.value="grey") +
    # scale_fill_brewer(type="qual", palette="Set1", guide="none", na.value="grey") +
    #scale_color_manual(values=colourvalues, na.value="grey") +
    #scale_fill_manual(values=colourvalues, guide="none", na.value="grey") +
    scale_x_continuous(breaks = seq(0,600,28), expand = expansion(mult=c(0,0.01)), label = label_number(1, 1/7))+
    scale_y_log10(
      expand = expansion(mult=c(0,0.01)),
      label=label_number_rr
    )+
    coord_cartesian(xlim=c(0, NA))+
    colour_guide+
    labs(
      x="Weeks",
      y="higher risk\n<- Pfizer BA.4-5 | Sanofi ->",
      title="Incidence rate ratio",
      colour=NULL
    )+
    theme_minimal(base_size = 9)+
    theme(
      legend.position="none",
      axis.text.x.top=element_text(hjust=0),
      #axis.line.y = element_line(colour = "darkgrey"),
      #axis.line.x.top = element_line(colour = "darkgrey"),
      
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      strip.background = element_blank(),
      strip.text = element_blank(),
      strip.placement="outside",
      panel.border = element_blank(),
      panel.spacing = unit(0.8, "lines")
    )+
    NULL
  
  
  n_subgroups <-
    rst[[cohort]]$estimates %>%
    filter(
      subgroup==subgroup0
    ) %>% 
    `[[`("subgroup_level_descr") %>%
    n_distinct()
  
  plot_combined <- patchwork::wrap_plots(
    plot_ci#, 
    plot_ci#, 
    #plot_rd, 
    #plot_rr, 
    #plot_irr,
    #ncol=2,
    #widths=c(n_subgroups,1)
    #plot_irr,
    #ncol=2,
    #widths=c(n_subgroups,1)
  )
  
  ggsave(
    filename=glue("ci_{cohort}_{subgroup}.png"),
    path=output_dir_qmd,
    plot=plot_combined,
    unit="cm",
    width=13,
    height=13
  )

  plot_combined
}

```

#### Figure 2a: Estimates in the CV cohort of cumulative risk per `r perN_format` people (left plots) and incidence rate ratios (right plots).

```{r figure-ci-cv-all}
#| echo: false

#| warning: false
#| out-width: '100%'
#| out-height: '80%'


plot_subgroup("cv", "all")
```

#### Figure 2b: Estimates in the 75+ cohort of cumulative risk per `r perN_format` people (left plots) and incidence rate ratios (right plots).

```{r figure-ci-age75plus-all}
#| echo: false
#| warning: false
#| out-width: '100%'
#| out-height: '80%'
#| out-height: '80%'

plot_subgroup("age75plus", "all")
```

Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

\newpage

#### Figure 3: Estimated incidence rate ratios at comparing the safety (4-weeks) and effectiveness (16-weeks) of Sanofi and Pfizer BA.4-5, overall and within subgroups.

```{r figure-contrasts-irr}
#| echo: false
#| warning: false
#| out-height: 50%

contrasts_plot <-
  contrasts_overall %>%
  filter(
    outcome %in% outcomes,
    subgroup %in% c("all"),
  ) %>%
  group_by(outcome_descr) %>%
  mutate(
    outcome_descr = fct_rev(outcome_descr),
    #outcome_descr = fct_relabel(outcome_descr, str_wrap, width=10),
    #subgroup_level_descr = fct_rev(subgroup_level_descr),
    #subgroup_level_descr = fct_recode(subgroup_level_descr, "All"=""),
    irrCI =   glue("{label_number_rr(irr)} ({label_number_rr(irr.ll)} - {label_number_rr(irr.ul)})"),
  ) %>%
  group_by(cohort_descr, outcome_descr) %>%
  mutate(
    irr.ln.p = if_else(row_number()==1 & (subgroup!="all"), irr.ln.p, NA_real_),
    irr.ln.p = if_else(irr.ln.p<0.001, "<0.001", label_number(0.001, trim=FALSE)(irr.ln.p))
  )

# create csv in form of Jasper plot
contrasts_jasper_plot <- contrasts_plot %>%
  ungroup()%>%
  summarise(
            Heading=outcome_descr,
            HR1=irr,
            LCI1=irr.ll,
            UCI1=irr.ul,
            ) %>%
  replace(is.na(.),Inf) %>%
  add_row( Heading ="",.before = 0) %>%
  add_row(Heading = "Clinically Vulnerable", .before = 1) %>%
  add_row(Heading ="", .after = length(outcomes) +2) %>%
  add_row( Heading="", .after = length(outcomes) +2) %>%
  add_row(Heading = "Aged 75 years or over", .after = length(outcomes) +3) 

write_csv(contrasts_jasper_plot, fs::path(output_dir_qmd,"irr_plots.csv"),na="")
write_csv(contrasts_jasper_plot, fs::path(output_dir_qmd,"irr_plots.csv"),na="")

# Run Jasper IRR plot script (requires https://github.com/arnhew99/Jasper?tab=readme-ov-file#jasper)
#source(here::here("write-up", "manuscript", "irr_plots_jasper_code.r"))
#source(here::here("write-up", "manuscript", "irr_plots_jasper_code.r"))

plot_irr_lines <- contrasts_plot %>%
  ggplot(aes(y=outcome_descr)) +
  geom_vline(aes(xintercept=1), linetype="dotted", colour="darkgrey")+
   geom_point(aes(x=irr), position=position_dodge(width=0.1))+
  geom_linerange(aes(xmin=irr.ll, xmax=irr.ul), position=position_dodge(width=0.1))+
  #facet_grid(rows=vars(outcome_descr), scales="free", space="free_y", switch="y")+
  facet_wrap(vars(cohort_descr), scales="free_y", ncol=1, strip.position = "top")+
  scale_x_log10(label=label_number(0.1, style_negative="minus", big.mark=","),n.breaks =8, oob=~oob_squish(.,range=log(c(0.2,8), 10)), expand=expansion())+
  #scale_fill_brewer(type="qual", palette="Set2")+
  scale_fill_manual(values=c("transparent", "darkgrey"))+
  labs(
    #subtitle="\n\n\nIncidence Rate Ratios",
    #subtitle="\n\n\nIncidence Rate Ratios",
    x="<- favours Sanofi  |  favours Pfizer BA.4-5 ->",
    y=NULL
  )+
  theme_minimal()+
  theme(
    plot.margin=grid::unit(c(0,0,0,0), "mm"),
    plot.subtitle=element_text(hjust=0.5, vjust=0),
    legend.position="none",
    #panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    #strip.background = element_blank(),
    #strip.placement="outside",
    strip.text = element_text(hjust=0),
    #strip.text.y.left = element_text(angle=0),
    #strip.text.y.left = element_blank(),
    panel.border = element_blank(),
    panel.spacing = unit(0.4, "lines"),
    panel.spacing = unit(0.4, "lines"),
  ) 
  
plot_irr_table <- contrasts_plot %>%
  ggplot(aes(y=outcome_descr)) +
  geom_text(aes(x=0.5, label=irrCI), hjust=0.5, vjust=0.5, size=9/.pt)+
  #geom_rect(aes(ymin=rownum-0.5, ymax=rownum+0.5, xmin=0.2, xmax=0.8, fill=patch), alpha=0.2)+
  facet_wrap(vars(cohort_descr), scales="free_y", ncol=1, strip.position = "top")+
  scale_fill_manual(values=c("transparent", "darkgrey"))+
  scale_x_continuous(expand=expansion())+
  #labs(subtitle="\nIncidence\nRate Ratio\n(95% CI)")+
  theme_minimal()+
  theme(
    plot.margin=grid::unit(c(0,0,0,0), "mm"),
    plot.subtitle=element_text(hjust=0.5, vjust=0),
    legend.position="none",
    panel.grid = element_blank(),
    strip.text =element_text(colour="transparent"),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x=element_blank(),
    panel.border = element_blank(),
    panel.spacing = unit(0.4, "lines"),
  )+
  NULL

# contrasts_plot %>% select(cohort_descr, subgroup_level_descr, outcome_descr, irrCI, irr.ln.p) %>% write_csv(here("table3.csv"))
#
# plot_p_table <- contrasts_plot %>%
#   ggplot() +
#   geom_text(aes(x=0.5, y=subgroup_level_descr, label=irr.ln.p), hjust=0.5, vjust=0.5, size=9/.pt, colour="transparent")+
#   geom_text(aes(x=0.5, y=midgroup, label=irr.ln.p), hjust=0.5, vjust=0.55, size=9/.pt)+
#   geom_rect(aes(ymin=rownum-0.5, ymax=rownum+0.5, xmin=0, xmax=1, fill=patch), alpha=0.2)+
#   facet_wrap(vars(outcome_descr), scales="free_y", ncol=1, strip.position = "top")+
#   scale_fill_manual(values=c("transparent", "darkgrey"))+
#   scale_x_continuous(expand=expansion())+
#   labs(subtitle="P for\nbetween\nsubgroup\ndifferences")+
#   theme_minimal()+
#   theme(
#     plot.margin=grid::unit(c(0,0,0,0), "mm"),
#     plot.subtitle=element_text(hjust=0.5, vjust=0),
#     legend.position="none",
#     panel.grid = element_blank(),
#     strip.text =element_text(colour="transparent"),
#     axis.text.y = element_blank(),
#     axis.title.y = element_blank(),
#     axis.text.x = element_blank(),
#     axis.title.x=element_blank(),
#     panel.border = element_blank(),
#     panel.spacing = unit(0.5, "lines"),
#   )+
#   NULL

  plot_combined <- patchwork::wrap_plots(
    plot_irr_lines,
    plot_irr_table,
    ncol=2,
    widths=c(2,0.9)
    ncol=2,
    widths=c(2,0.9)
  )

  ggsave(
    filename=glue("irr_pvals.jpeg"),
    path=output_dir_qmd,
    plot=plot_combined,
    width=20, height=15, units="cm"
    width=20, height=15, units="cm"
  )

plot_combined



cat("  \n\n")

```

\newpage

## References
