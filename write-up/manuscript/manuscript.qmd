---
title: "Comparative effectiveness of Pfizer B.A4-5 versus Sanofi during the Spring 2023 COVID-19 booster programme in England: a cohort study in OpenSAFELY-TPP"
format:
  # html:
  #   toc: false
  #   embed-resources: true
  docx
knitr:
  opts_chunk: 
    collapse: true
    echo: false
    fig.path: ./write-up/figures/
    fig.pos: H
    R.options:
      knitr.graphics.auto_pdf: true
bibliography: references.bib
csl: vancouver.csl
link-citations: true
zotero: yes
header-includes:
- \usepackage{float} 
- \floatplacement{figure}{H}
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
- \captionsetup[table]{labelformat=empty}
---

```{r}
#| label: setup
#| include: false
#| message: false
#| warnings: false
source(here::here("write-up", "manuscript", "setup.R"))
```

```{r}
#| label: process
#| include: false
#| message: false
source(here("write-up", "manuscript", "import-process.R"))
```

William J Hulme^1^, Edward PK Parker^2^, Em Prestige^2^, Ruth H Keogh^2^, Elizabeth J Williamson^2^, Venexia Walker^3,4^, Tom Palmer^3,4^, Helen J Curtis^1^, Alex Walker^1^, Colm Andrews^1^, Amir Mehrkar^1^, Brian MacKenna^1^, Sebastian CJ Bacon^1^, Ben Goldacre^1^, Miguel A HernÃ¡n^6,7^\*, Jonathan AC Sterne^3,5,8^\*, and the OpenSAFELY collaborative.

1\. The Bennett Institute for Applied Data Science, Nuffield Department of Primary Care Health Sciences, University of Oxford, OX26GG, UK

2\. London School of Hygiene and Tropical Medicine, Keppel Street, London, WC1E 7HT, UK

3\. Population Health Sciences, University of Bristol, Oakfield House, Oakfield Grove, Bristol, BS8 2BN, UK

4\. MRC Integrative Epidemiology Unit, Bristol Medical School, University of Bristol, Bristol, UK

5\. NIHR Bristol Biomedical Research Centre, Bristol, UK

6\. CAUSALab, Harvard T.H. Chan School of Public Health, Boston, MA 02115

7\. Departments of Epidemiology and Biostatistics, Harvard T.H. Chan School of Public Health, Boston, MA 02115

8\. Health Data Research UK South West

\newpage

## Abstract

*Introduction* The spring 2023 COVID-19 booster vaccination programme in England used both Pfizer Ba45 and Sanofi vaccines. All people aged 75 years and over, or considered to be clinically vulnerable were eligible to receive a booster dose. Direct comparisons of the effectiveness against severe COVID-19 of these two vaccines for boosting have not been made in trials or observational data.

*Methods* On behalf of NHS England, we used the OpenSAFELY-TPP database to compare recipients of each vaccine, investigating the over 75s and the clinically vulnerable groups separately. Recipients were matched on date of vaccination, vaccine history, age, and other characteristics. Recipients were included if boosted between 1 April and 30 June 2023, and followed up for X weeks. Outcomes were COVId-19 emergency department attendance, COVID-19 hospital admission, and COVID-19 death. We estimated the cumulative incidence of each outcome, and quantified comparative effectiveness using risk differences (RD) and incidence rate ratios (IRRs).

*Results* `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c4") %>% pull(n) %>% sum())` people were 1-1 matched in the CV cohort, and `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c4") %>% pull(n) %>% sum())` in the 75+ cohort, contributing a total `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(persontime_weeks)` and `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(persontime_weeks)` person-weeks of follow-up respectively.

In both CV and 75+ cohorts, effectiveness against all measured COVID-19-related outcomes was similar. This finding was observed overall and in pre-specified subgroups.

In the CV cohort, the X-week risks per `r perN_format` of COVID-19 A&E attendance were `r rst$cv$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(riskCI_0_95)` for Pfizer B.A4-5 and `r rst$cv$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(riskCI_1)` for Sanofi: the IRR comparing Sanofi with PfizerB.A4-5 was `r rst$cv$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(irrCI)`. For COVID-19 hospitalisation, X-week risks were `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_0)` and `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_1)`: IRR `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(irrCI)`. For COVID-19 death: `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_0)` and `r contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_1)`: IRR `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(irrCI)`.

In the 75+ cohort, the X-week risks per `r perN_format` for COVID-19 A&E attendance were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(riskCI_0_95)` for Pfizer B.A4-5 and `r rst$age75plus$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(riskCI_1)` for Sanofi: the IRR comparing Sanofi with PfizerB.A4-5 was `r rst$age75plus$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(irrCI)`. For COVID-19 hospitalisation, X-week risks were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_0)` and `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_1)`: IRR `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(irrCI)`. For COVID-19 death: `r perN_format` were `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_0)` and `r contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_1)`: IRR `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(irrCI)`.

*Conclusion* This observational study comparing effectiveness of PFizer and Sanofi vaccine during the Spring 2023 programme in England in the two main eligible cohorts -- people aged 75 and over and in clinically vulnerable people -- found no evidence of substantial differences between the two vaccine products within the first X weeks after vaccination.

\newpage

```{r break1}
2+2
```

## Background

In X 2022, NHS XXX in England announced the Spring 2023 COVID-19 booster vaccination programme, available to those aged 75 years and over, and those considered to be vulnerable to infection or severe COVID-19 disease, based on guidance from the Joint Committee for Vaccination and Immunisation (JCVI) @covid19,. The use of the both the Pfizer-BioNTech B.A.4/5 vaccine and the Sanofi vaccine during the spring 2023 programme enables a direct comparison of their effectiveness against severe COVID-19 disease, which has not yet been conducted in randomised trials.

On behalf of NHS England, we used the OpenSAFELY-TPP database, covering around 45% of English primary care practices and linked to hospital and death records, to compare the effectiveness of boosting with Pfizer and Sanofi in the 75+ years group and the clinically vulnerable group who received either vaccine in the spring 2023 programme. During this period and the weeks following, the X variant was dominant.

\newpage

## Methods

### Data source

All data were linked, stored and analysed securely within the OpenSAFELY platform: <https://opensafely.org/>. With the approval of NHS England, primary care records managed by the GP software provider TPP were linked, using NHS numbers, to A&E attendance and in-patient hospital spell records via NHS Digital's Hospital Episode Statistics (HES), national coronavirus testing records via the Second Generation Surveillance System (SGSS), and national death registry records from the Office for National Statistics (ONS). COVID-19 vaccination history and health and social care worker status is available in the GP record directly via the National Immunisation Management System (NIMS).

### Eligibility criteria

We considered two cohorts: all adults aged 75 years or over ("75+"), and all adults aged 18 or over who were classified as clinically vulnerable ("CV"). These groups are not mutually exclusive. Clinical vulnerability encompasses various chronic or immunocompromising conditions, immunosuppressive treatments, and ..., and is defined fully in supplementary materials.

In each group, any person receiving a Pfizer or Sanofi vaccine dose between `r study_dates_format$studystart_date` and `r study_dates_format$studyend_date` inclusive were considered for inclusion. People were eligible if they: were registered at a GP practice using TPP's SystmOne clinical information system at the time of boosting; were not a health or social care worker, not resident in a care or nursing home and not medically housebound or receiving end-of-life care; had no evidence of SARS-CoV-2 infection or COVID-19 disease within the previous 90 days; were not hospitalised at the time of boosting; and had complete information on sex, deprivation, and Sustainability and Transformation Partnership (STP, a geographical grouping of NHS and local authorities).

### Matching

Pfizer and Sanofi booster recipients were matched 1-1 without replacement, on the following characteristics: date of vaccination; number of previous COVID-19 vaccine doses; time since previous COVID-19 vaccine dose; sex (male or female); age (3 year caliper and within age groups defined by JVCI risk groups); Index of Multiple Deprivation (IMD, grouped by quintile); STP as a surrogate for geographical region; evidence of prior SARS-CoV-2 infection (any of positive SARS-CoV-2 test, probable infection documented in primary care, or COVID-19 hospital attendance or admission); and morbidity count (grouped as 0, 1, or 2 or more conditions from the following list: diabetes, BMI over 40kg/m^2^, chronic heart disease, chronic kidney disease, chronic liver disease, chronic respiratory disease or severe asthma, chronic neurological disease, cancer within 3 years). Clinical vulnerability was an additional matchng factor in the 75+ cohort.

There are no missing values for these variables: people with missing values for sex, IMD or STP were excluded, and all other variables were defined by the presence or absence of clinical codes or events.The supplementary materials provide more information on how these characteristics were chosen and defined.

### Outcomes and follow-up

We considered three primary outcomes. COVID-19 emergency department admission was identified using HES emergency department records, with SNOMIED.

COVID-19 hospitalisation was identified using Secondary Use Service (SUS) in-patient hospital records with International Statistical Classification of Diseases and Related Health Problems 10th Revision (ICD-10) codes U07.1, U07.2, or U.109 as the primary or non-primary reason for admission. COVID-19 death was defined as death with U07.1, U07.2, or U.109 ICD-10 codes mentioned anywhere on the death certificate (i.e., as an underlying or contributing cause of death). We also report on non-COVID-19 deaths.

<!-- We also considered the follows safety outcomes: -->

<!-- * Adverse allergic reaction / Anaphylaxis -->

<!-- * Myocarditis or Pericarditis -->

<!-- *  -->

<!--# COVID-19 related A&E attendance and critical/intensive care admission we also considered but there were doubts over data the reliability of event ascertainment in these cases. -->

Each person was followed from receipt of vaccination (time zero) until the outcome of interest, with censoring at death, practice de-registration, XX weeks, or `r study_dates_format$followupend_date`.

### Statistical Analysis

Baseline characteristics of each vaccine group were tabulated, with between-group balance examined using standardised mean differences. We estimated the cumulative incidence of each outcome in each vaccine group using the Kaplan-Meier (KM) estimator. We estimated cumulative risk differences and risk ratios (RRs) comparing the vaccine groups for each outcome. These were estimated up to 20 weeks where available, but estimates at X weeks are reported as the primary comparison to ensure potential follow-up in those vaccinated towards the end of the booster programme was not censored. We also estimated Incidence Rate Ratios (IRRs) over the first X weeks, and within period-specific intervals defined by splits on weeks 1, 2, 4, 8, 12, 16, and X, where available.

<!-- days 7, 14, 21, 28, 42, 56, 70, 84, 112, 140, 168 and 196. -->

<!-- 95% confidence limits for the AJ estimates were derived from a Greenwood-type formula. Confidence limits for the risk difference were derived from the sum of squares of the AJ standard errors, derived from Greenwoodâs formula. Confidence limits for the survival ratio were based on the standard error of the cumulative hazard. Confidence limits for the risk ratio were derived using the Delta method. -->

95% confidence limits for the cumulative incidences were derived using standard errors on the log-KM scale. Confidence limits for the risk differences were derived from the sum of squares of the standard errors on the KM scale, using Greenwood's formula. Confidence limits for the risk ratio were derived from the sum of squares of the standard errors on the log-KM scale. Confidence limits for the IRRs were derived from the sum of squares of the standard errors on the log-KM scale. <!-- 95% confidence limits for the Kaplan-Meier estimates, risk differences, risk ratios, and incidence rate ratios are derived by bootstrapping the matched pairs. 500 bootstrap replicates will be used. -->

### Subgroup and secondary analyses

We estimated comparative effectiveness separately in the following subgroups: age band in the CV group only (18-39, 40-54, 55-64, 65-74, 75+); clinical vulnerability in the 75+ group only; prior vaccination history; evidence of prior SARS-CoV-2 infection or not. We used $\chi^2$ tests to examine evidence for heterogeneity in comparative effectiveness between subgroups.

We reported the rates of SARS-CoV-2 tests undertaken from baseline up to 31 March 2022 in each vaccine group, as lower testing rates in one group might lead to under-ascertainment of outcomes, particularly positive SARS-CoV-2 tests.

We reported outcomes at one week as a negative control outcome @Lipsitch2010, during which time the vaccine is not expected to have any protective immunological effect.

### Disclosure control

To satisfy strict re-identification minimisation requirements for statistical outputs from OpenSAFELY's Trusted Research Environment, counts were rounded to the nearest 3, 9, 15, and so on. Plots of cumulative event counts and the Kaplan-Meier cumulative incidence estimates were rounded such that each increment is based on at least 6 events. Event rates, risk differences, and risk ratios were derived from these rounded estimates.

### Software, code, and reproducibility

Data management and analyses were conducted using OpenSAFELY tools, Python version 3.8.10 and R version 4.0.2. All code is shared openly for review and re-use under MIT open license at <https://github.com/opensafely/comparative-booster-spring2023>. Codelists are available at <https://www.opencodelists.org/>. The supplementary materials provide further details of codelists and data sources used for all variables in the study. Detailed pseudonymised patient data is potentially re-identifiable and therefore not shared.

\newpage

## Results

```{r break2}
2+2
```

### Study population and matching

\[\[fix total identified in data_process script then re-write\]\]

<!-- We identified `r label_number(1, big.mark=",")(filter(rst$cv$total_flowchart, boost_type=="Any") %>% pull(n) %>% sum)` clinically vulnerable people and `r label_number(1, big.mark=",")(filter(rst$age75plus$total_flowchart, boost_type=="Any") %>% pull(n) %>% sum)` people aged 75 or over who were recorded as having received a COVID-19 vaccine between `r study_dates_format$studystart_date` and `r study_dates_format$studyend_date` whilst registered at a TPP practice. This included `r label_number(1, big.mark=",")(filter(rst$age75plus$total_flowchart, boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$total_flowchart, boost_type=="pfizerBA45") %>% pull(pct))`) Pfizer B.A4/5 and `r label_number(1, big.mark=",")(filter(rst$cv$total_flowchart, boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$total_flowchart, boost_type=="sanofi") %>% pull(pct))`) Sanofi. -->

<!-- `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c0") %>% pull(n) %>% sum())` were in the CV cohort, and of these `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c1", boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c1", boost_type=="pfizerBA45") %>% pull(pct_all))`) received Pfizer BA45 and `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c1", boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c1", boost_type=="sanofi") %>% pull(pct_all))`) received Sanofi, with `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c3", boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c3", boost_type=="pfizerBA45") %>% pull(pct_all))`) and `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c3", boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c3", boost_type=="sanofi") %>% pull(pct_all))`) eligible for matching respectively (Figure 1). -->

`r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c0") %>% pull(n) %>% sum())` were in the 75+ cohort, and of these `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c1", boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c1", boost_type=="pfizerBA45") %>% pull(pct_all))`) received Pfizer BA45 and `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c1", boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c1", boost_type=="sanofi") %>% pull(pct_all))`) received Sanofi, with `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c3", boost_type=="pfizerBA45") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c3", boost_type=="pfizerBA45") %>% pull(pct_all))`) and `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c3", boost_type=="sanofi") %>% pull(n))` (`r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c3", boost_type=="sanofi") %>% pull(pct_all))`) eligible for matching respectively (Figure 1).

Eligible Pfizer BA45 recipients were on average older, more deprived and had higher rates of prior clinical conditions than Sanofi recipients (supplementary Table S1). They were also more likely to have received more/less/X prior COVID-19 vaccine doses...

In the CV cohort, `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(n))` people in each vaccine group (total `r label_number(1, big.mark=",")(filter(rst$cv$flowchart, crit=="c4", boost_type %in% c("pfizerBA45", "sanofi")) %>% pull(n) %>% sum())`) were matched, representing `r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(pct_step))` and `r label_percent(0.1)(filter(rst$cv$flowchart, crit=="c4", boost_type=="sanofi") %>% pull(pct_step))` of eligible Pfizer and Sanofi recipients respectively (Figure 1, Figure S1).

In the 75+ cohort, `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(n))` were matched in each vaccine group (total `r label_number(1, big.mark=",")(filter(rst$age75plus$flowchart, crit=="c4", boost_type %in% c("pfizerBA45", "sanofi")) %>% pull(n) %>% sum())`), representing `r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c4", boost_type=="pfizerBA45") %>% pull(pct_step))` and `r label_percent(0.1)(filter(rst$age75plus$flowchart, crit=="c4", boost_type=="sanofi") %>% pull(pct_step))` of eligible Pfizer and Sanofi recipients respectively (Figure 1, Figure S1).

Characteristics at the start of follow-up were well-balanced between groups (Table 1) with standardised mean differences consistently below 0.05 (supplementary Figure S2 and Table S1).

In particular, prior clinical conditions, which were not directly matched on, were well-balanced between the groups after, though not before, matching. The median follow-up was X weeks for COVID-19 death outcomes (Table S3).

SARS-CoV-2 testing rates after baseline were slightly less frequent for Pfizer BA45 than for Sanofi: `r rst$cv$eventcounts %>% filter(subgroup=="all", treatment==0) %>% pull(test_rate) %>% {label_number(0.001, 7)(.)}` versus `r rst$cv$eventcounts %>% filter(subgroup=="all", treatment==1) %>% pull(test_rate) %>% {label_number(0.001, 7)(.)}` per week for the CV cohort; and `r rst$age75plus$eventcounts %>% filter(subgroup=="all", treatment==0) %>% pull(test_rate) %>% {label_number(0.001, 7)(.)}` versus `r rst$age75plus$eventcounts %>% filter(subgroup=="all", treatment==1) %>% pull(test_rate) %>% {label_number(0.001, 7)(.)}` per week for the 75+ cohort (supplementary Table S4).

### Estimated comparative effectiveness

#### CV cohort

```{r break3}
2+2
```

By X weeks there were `r rst$cv$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(n.event)` COVID-19 A&E attendances, `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(n.event)` COVID-19 hospitalisations, and `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(n.event)` COVID-19 deaths (Table 2).

<!-- across `r contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(persontime_weeks)` person-weeks of follow-up (Table 2). -->

The X-week risks (cumulative incidence) per `r perN_format` people of COVID-19 A&E attendances were `r rst$cv$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(riskCI_0_95)` for those receiving Pfizer BA45 and `r rst$cv$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$cv$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(rdCI_95)`) (Table 2; Figure 2). The corresponding X-week risks per `r perN_format` people for COVID-19 hospitalisation were `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA45 and `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(rdCI)`). The X-week risks per `r perN_format` people of COVID-19 death were `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA45 and `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(rdCI)`). For non-COVID-19 death, these were `r rst$cv$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA45 and `r rst$cv$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$cv$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(rdCI)`).

<!-- For COVID-19 A&E attendance, the cumulative risk ratio comparing Sanofi with Pfizer BA45 reached a minimum of 0.91 (0.90 to 0.92) at 4 weeks, then attenuated with increasing follow up (Figure 2). -->

<!-- For COVID-19 hospitalisation the minimum risk ratio was 0.67 (0.59 to 0.76) at around 11 weeks, attenuating to 0.89 (0.83 to 0.96) by 28 weeks. -->

<!-- The number of COVID-19 deaths was too small to reliably examine patterns of cumulative incidence over time. -->

<!-- For non-COVID-19 death the risk ratio was imprecisely estimated in the first few weeks, but stabilised to 0.92 (0.86 to 0.99) at 28 weeks. -->

IRRs (where less than one favours Sanofi) in the X-week period after vaccination were `r rst$cv$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(irrCI_95)` for COVID-19 A&E attendances, `r rst$cv$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(irrCI)` for COVID-19 hospitalisation, `r rst$cv$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(irrCI)` for COVID-19 death, and `r rst$cv$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(irrCI)` for non-COVID-19 death (Figure 3).

Period-specific IRRs are displayed in Supplementary Figure S4a. During the first week after vaccination event rates were similar between vaccine groups: the estimated HR was `r rst$cv$contrasts_cuts_table %>% filter(outcome=="covidemergency", subgroup=="all", fup_start==0, fup_end==7) %>% pull(irrCI_95)` for COVID-19 A&E attendances, `r rst$cv$contrasts_cuts_table %>% filter(outcome=="covidadmitted", subgroup=="all", fup_start==0, fup_end==7) %>% pull(irrCI)` for COVID-19 hospitalisation, `r rst$cv$contrasts_cuts_table %>% filter(outcome=="coviddeath", subgroup=="all", fup_start==0, fup_end==7) %>% pull(irrCI)` for COVID-19 death, `r rst$cv$contrasts_cuts_table %>% filter(outcome=="noncoviddeath", subgroup=="all", fup_start==0, fup_end==7) %>% pull(irrCI)` for non-COVID-19 death. After this initial period, the rate for A&E was lower for Sanofi than Pfizer BA45 until week X, after which they were higher for Sanofi. For COVID-19 hospitalisation, the minimum IRR was X (X to X) during weeks 5-8, with IRRs between X and X weeks consistent with no difference between vaccine groups. For non-COVID-19 death IRRs were consistently close to 1.

#### 75+ cohort

```{r break4}
2+2
```

By X weeks there were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(n.event)` COVID-19 A&E attendances, `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(n.event)` COVID-19 hospitalisations, and `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(n.event)` COVID-19 deaths (Table 2).

<!-- across `r contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(persontime_weeks)` person-weeks of follow-up (Table 2). -->

The X-week risks (cumulative incidence) per `r perN_format` people of COVID-19 A&E attendances were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(riskCI_0_95)` for those receiving Pfizer BA45 and `r rst$age75plus$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$age75plus$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(rdCI_95)`) (Table 2; Figure 2). The corresponding X-week risks per `r perN_format` people for COVID-19 hospitalisation were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA45 and `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(rdCI)`). The X-week risks per `r perN_format` people of COVID-19 death were `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA45 and `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(rdCI)`). For non-COVID-19 death, these were `r rst$age75plus$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(riskCI_0)` for Pfizer BA45 and `r rst$age75plus$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(riskCI_1)` for Sanofi (risk difference `r rst$age75plus$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(rdCI)`).

<!-- For COVID-19 A&E attendance, the cumulative risk ratio comparing Sanofi with Pfizer BA45 reached a minimum of 0.91 (0.90 to 0.92) at 4 weeks, then attenuated with increasing follow up (Figure 2). -->

<!-- For COVID-19 hospitalisation the minimum risk ratio was 0.67 (0.59 to 0.76) at around 11 weeks, attenuating to 0.89 (0.83 to 0.96) by 28 weeks. -->

<!-- The number of COVID-19 deaths was too small to reliably examine patterns of cumulative incidence over time. -->

<!-- For non-COVID-19 death the risk ratio was imprecisely estimated in the first few weeks, but stabilised to 0.92 (0.86 to 0.99) at 28 weeks. -->

IRRs (where less than one favours Sanofi) in the X-week period after vaccination were `r rst$age75plus$contrasts_table %>% filter(outcome=="covidemergency", subgroup=="all") %>% pull(irrCI_95)` for COVID-19 A&E attendance, `r rst$age75plus$contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="all") %>% pull(irrCI)` for COVID-19 hospitalisation, `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(irrCI)` for COVID-19 death, and `r rst$age75plus$contrasts_table %>% filter(outcome=="noncoviddeath", subgroup=="all") %>% pull(irrCI)` for non-COVID-19 death (Figure 3).

Period-specific IRRs are displayed in Supplementary Figure S4a. During the first week after vaccination event rates were similar between vaccine groups: the estimated HR was `r rst$age75plus$contrasts_cuts_table %>% filter(outcome=="covidemergency", subgroup=="all", fup_start==0, fup_end==7) %>% pull(irrCI_95)` for COVID-19 A&E attendances, `r rst$age75plus$contrasts_cuts_table %>% filter(outcome=="covidadmitted", subgroup=="all", fup_start==0, fup_end==7) %>% pull(irrCI)` for COVID-19 hospitalisation, `r rst$age75plus$contrasts_cuts_table %>% filter(outcome=="coviddeath", subgroup=="all", fup_start==0, fup_end==7) %>% pull(irrCI)` for COVID-19 death, `r rst$age75plus$contrasts_cuts_table %>% filter(outcome=="noncoviddeath", subgroup=="all", fup_start==0, fup_end==7) %>% pull(irrCI)` for non-COVID-19 death. After this initial period, the rate for A&E was lower for Sanofi than Pfizer BA45 until week X, after which they were higher for Sanofi. For COVID-19 hospitalisation, the minimum IRR was X (X to X) during weeks 5-8, with IRRs between X and X weeks consistent with no difference between vaccine groups. For non-COVID-19 death IRRs were consistently close to 1.

### Subgroup analyses

Findings in the main analyses were similar when examining subgroups...

<!-- For COVID-19 A&E attendances the estimated relative benefit of Sanofi compared with Pfizer BA45 was greater/lower in those with fewer prior vaccines (IRR `r contrasts_table %>% filter(outcome=="covidemergency", subgroup=="covid_vax_history", subgroup_level=="pfizer-pfizer") %>% pull(irrCI_95)`) than in those who received ChAdOx1 (IRR `r contrasts_table %>% filter(outcome=="covidemergency", subgroup=="vax12_type", subgroup_level=="az-az") %>% pull(irrCI_95)`, heterogeneity p=`r contrasts_table %>% filter(outcome=="covidemergency", subgroup=="vax12_type", subgroup_level=="az-az") %>% pull(coxhr.ln.p) %>% first()`) (Figure 3). -->

<!-- Similarly, the estimated relative benefit of mRNA-1273 compared with BNT162b2 was greater in those with prior evidence of infection (IRR `r contrasts_table %>% filter(outcome=="covidemergency", subgroup_level=="TRUE", subgroup=="prior_covid_infection") %>% pull(irrCI_95)`) versus those without (IRR `r contrasts_table %>% filter(outcome=="covidemergency", subgroup_level=="FALSE", subgroup=="prior_covid_infection") %>% pull(irrCI_95)`, heterogeneity p=`r contrasts_table %>% filter(outcome=="covidemergency", subgroup_level=="FALSE", subgroup=="prior_covid_infection") %>% pull(coxhr.ln.p) %>% first()`). -->

<!-- For COVID-19 hospitalisation the estimated relative benefit of mRNA-1273 compared with BNT162b2 was similar by type of first two vaccine doses (IRR `r contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="vax12_type", subgroup_level=="pfizer-pfizer") %>% pull(irrCI_95)` for BNT162b2 and `r contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="vax12_type", subgroup_level=="az-az") %>% pull(irrCI_95)` for ChAdOx1; heterogeneity p=`r contrasts_table %>% filter(outcome=="covidadmitted", subgroup=="vax12_type", subgroup_level=="az-az") %>% pull(coxhr.ln.p) %>% first()`). -->

<!-- The estimated relative benefit of mRNA-1273 was greater in those with prior evidence of infection (IRR `r contrasts_table %>% filter(outcome=="covidadmitted", subgroup_level=="TRUE", subgroup=="prior_covid_infection") %>% pull(irrCI_95)`) than those without (IRR `r contrasts_table %>% filter(outcome=="covidadmitted", subgroup_level=="FALSE", subgroup=="prior_covid_infection") %>% pull(irrCI_95)`, heterogeneity p=`r contrasts_table %>% filter(outcome=="covidadmitted", subgroup_level=="FALSE", subgroup=="prior_covid_infection") %>% pull(coxhr.ln.p) %>% first()`). -->

<!-- For COVID-19 death, IRRs were estimated imprecisely due to low event rates so no strong conclusions about variation between subgroups could be made. -->

<!-- For Non-COVID-19 death, the relative benefit of mRNA-1273 was generally greater in older and more clinically vulnerable people. -->

Supplementary materials provide cumulative incidence plots by subgroup (Figures S3a-e), the corresponding cumulative risk differences, cumulative risk ratios, and period-specific IRRs (Figures S4a-e), and subgroup-specific heterogeneity tests for risk differences and risk ratios (Table S2).

\newpage

## Discussion

This observational study in over X million adults receiving a COVID-19 vaccine during the Spring 2023 booster programme in England compared the effectiveness of Sanofi versus Pfizer BA45 vaccines and is, to our knowledge, the first to do so against severe COVID-19 outcomes. We estimated that ... there were no substantial differences between either vaccine on any of the studies effectiveness outcomes during the first X weeks after vaccination. Estimates appeared broadly similar regardless of age, clinical vulnerability, and ...

Rates of COVID-19-related events were higher (the cumulative incidence curve is stepper) during the immune induction period up to 2 weeks, during which time the booster dose has yet to take full effect, than subsequently. Consistent with this delayed immunity, rates of the outcomes were similar for the two vaccines in the first week of follow-up, though rates also remained similar after this period.

Only `r rst$age75plus$contrasts_table %>% filter(outcome=="coviddeath", subgroup=="all") %>% pull(n.event)` people aged 75 or over died with COVID-19 recorded as an underlying or contributory cause across both vaccine groups within X weeks (1 in 38,500) so the IRR was estimated imprecisely. <!-- The risk of non-COVID-19 death was around 1 in 1,600 people, and was marginally lower/higher for Sanofi than Pfizer BA45. --> <!-- This could indicate differences in vaccine safety, under-ascertainment of COVID-19 related deaths (for example post-COVID cardiovascular deaths not directly attributed to SARS-CoV-2 infection), or sub-optimal confounding control. -->

### Strengths and limitations

The OpenSAFELY-TPP database covers around 45% of the English population and contains rich clinical information which enabled us to closely match Sanofi and Pfizer BA45 recipients to control for potential confounding, to study a range of clinical outcomes, including severe COVID-19, and compare comparative safety and effectiveness between important clinical subgroups.

To make fair comparisons between the two vaccine types, we exploited the concurrent roll-out of both vaccines across the same eligible population during the same time period. The type of vaccine administered was based largely on local supply and availability, and clinical characteristics did not inform the type of vaccine offered on-site \[except for age??\]. It remained important to control for any potential differences in the distribution of prognostic factors between the two vaccine groups, and these were well-balanced after matching. We cannot rule out residual confounding as we did not match on or adjust for all potential confounders, for example some clinical subgroups where relative protection between vaccines may differ such as immunosuppressive conditions. However, unmeasured potential confounders, particularly relating to unmeasured health-seeking behaviours, are less problematic in comparative effectiveness studies than in studies comparing vaccinated with unvaccinated people, as all people entering the study have sought and received at three vaccine doses. We found no evidence that rates of other outcomes during the first week after vaccination differed between the vaccine groups, although some of these comparisons were estimated imprecisely.

<!--# [People were usually not offered a choice of vaccine type (although they could refuse boosting if they were not offered their preference) and clinical characteristics did not inform the type of vaccine offered. Anecdotally, we understand that occasionally some people were offered a choice in centres using both vaccines, though we are not aware of any specific policy that allowed this.] -->

We excluded groups who were unlikely to undergo boosting such as those in palliative care. We also excluded those identified as health and social care workers due to these groups being much more likely to receive their vaccines at their place of work, rather than at walk-in or bookable community vaccination centres, which may introduce bias. For example, occupation type for health care workers may influence both vaccine administration setting (and therefore vaccine type) and risk of infection.

<!-- The later introduction of the mRNA-1273 vaccine for the UK booster campaign meant that the matched cohort contained younger and healthier people than the whole population receiving a third dose, due to the prioritisation of older and higher risk people. -->

<!-- For example, the number of people with immunosuppressive conditions in the matched cohort was just 1.5%. -->

<!-- The applicability of our findings to the most vulnerable groups may therefore be limited. -->

<!-- However, numbers remained sufficient to compare subgroups defined by age, clinical vulnerability, and prior infection status, including for COVID-19 hospitalisation. -->

To control for spatio-temporal heterogeneity in infection risk during the study period we matched on the date of third dose receipt and local health administration (STP). Some residual heterogeneity within STP regions is possible, but more precise geographical matching was not feasible due to poor matching success at this level, partly due to time periods during which only one vaccine type was available within a small geographical area.

Post-baseline SARS-CoV-2 testing rates were slightly higher in X than in X recipients, which largely rule out differences in testing behaviours between vaccine groups.

This study does not include anyone who received the Moderna mRNA-1273 vaccine which was also available during the spring 2023 booster programme but was administered much more infrequently.

### Findings in context

<!-- The COV-BOOST phase II randomised trial assessed the safety and immunogenicity of seven COVID-19 vaccines for boosting, including BNT162b2 and mRNA-1273 against a menACWY control in people with no prior history of infection @munro2021. -->

<!-- It found higher immunogenicity of mRNA-1273 compared with BNT162b2 in subgroups with a two-dose BNT162b2 primary course (geometric mean ratio (GMR) of SARS-CoV-2 anti-spike IgG versus control = 11.49 (95%CI 9.36 to 14.12) versus (6.78 (5.51 to 8.35)) and a two-dose ChAdOx1 primary course (GMR = 32.30 (24.84 to 42.01) versus 16.80 (12.97 to 21.76)). -->

<!-- Likewise, the MixNMatch phase I-II non-randomised trial documented higher antibody levels after mRNA-1273 boost than BNT162b2 boost among individuals who received a primary course of BNT162b2 @atmar2022. -->

<!-- These trials did not evaluate efficacy endpoints, and we are aware of no other planned or published randomised trials making direct comparisons of boosting with BNT162b2 versus mRNA-1273. -->

<!-- A study in Spanish registry data of people aged 40 years or over with no previous positive test for SARS-CoV-2 examined effectiveness of mRNA vaccine boosting, including a comparison of BNT162b2 with mRNA-1273 @monge2022. -->

<!-- For positive SARS-CoV-2 tests, it estimated a 34-day risk difference comparing mRNA-1273 with BNT162b2 of â2.2 (â2.7 to â1.6) per 1,000 people (risk ratio 0.87 (0.84, 0.90)). -->

<!-- There was no assessment of effectiveness against hospitalisation or other severe outcomes. -->

<!-- A study in US Veteran Affairs health care system in the Alpha and Delta eras using a similar matching approach @dickermanComparativeEffectivenessThird2023, with 65,196 matched recipients in each vaccine group, reported 16-week risk ratio of 0.87 (0.77 to 0.94) for documented SARS-CoV-2 infection, 0.61 (0.36 to 0.79) for COVID-19 hospitalisation and 0.92 (0.16 to 2.17) for COVID-19 death. -->

<!-- Comparisons of vaccines for primary vaccination in observational data have also been made. -->

<!-- Another US Veteran Affairs study by the same group during the Alpha period @dickerman2022, identified an additional 1.23 (95% CI 0.72 to 1.81) documented infections per 1,000 people in those with a BNT162b2 first dose compared with a mRNA-1273 first dose at 24 weeks, 0.55 (95%CI 0.36 to 0.83) COVID-19 hospitalisations, 0.10 (95%CI 0.00 to 0.26) COVID-19 ICU admissions, and 0.02 (95%CI â0.06 to 0.12) COVID-19 deaths. -->

<!-- Another study using Veterans Affairs data with exact- and propensity-matching in a similar time period @ioannou2022a, estimated similar differences at 24 weeks for documented infection (1.73, 95%CI 1.50 to 1.96 additional events per 1,000 people in those with a BNT162b2 first dose compared with a mRNA-1273), COVID-19 hospitalisation (0.56, 95%CI 0.45 to 0.67) and COVID-19 death (0.03, 95%CI -0.00 to 0.07). -->

<!-- Accounting for the longer follow-up period and statistical uncertainty, these estimates are consistent with our findings for the comparative effectiveness of mRNA-1273 versus BNT162b2 boosting. -->

<!-- A third Veteran Affairs study compared three doses of BNT162b2 with three doses of mRNA-1273 in the Omicron era in a secondary analysis. https://doi.org/10.1093/cid/ciac328 -->

<!-- A study using English data to estimate the effectiveness of BNT162b2 boosting versus no boosting and mRNA-1273 boosting versus no boosting separately using a test-negative-control design @andrews2022, suggests marginally higher effectiveness against symptomatic disease in mRNA-1273 than in BNT162b2, but this assumes that the respective control populations in each analysis were similar. -->

<!-- The evidence therefore strongly points to a benefit of mRNA-1273 over BNT162b2 for primary vaccination and subsequent booster doses. -->

<!-- This is relevant to vaccine procurement decisions for future booster programmes. -->

<!-- However, both vaccines are safe [@barda2021a; @klein2021; @diaz2021; @dickerman2022a] and strongly effective [@hulme2022; @barda2021; @andrews2022; @monge2022] against infection and COVID-19 disease, compared to no boosting. -->

<!-- Findings from this study should not discourage individuals from receiving BNT162b2 booster vaccination if offered. -->

<!-- Though small, an additional 0.22 hospitalisations per 1,000 people becomes 100s or over 1,000 hospitalisations in England at a population level, depending on booster uptake and infection risk, contributing substantially to healthcare resource use both during the acute phase of disease and by those with longer-term illness -->

### Conclusions

COVID-19-related outcomes after vaccination with Sanofi or Pfizer BA45 during the Spring 2023 booster programme in England were rare, though risks were estimated to be similar between vaccine types. These finding were broadly consistent across subgroups. Given the similarly in effectiveness of the two vaccines compared in this study, future COVID-19 booster programmes may focus on other characteristics of the vaccines, for instance cost effectiveness or logistical constraints, to determine which to recommend for roll-out.

\newpage

## Contributions

Conceptualization: WJH, EPKP, RHK, EJW, VW, TP, BG, MAH, and JACS. Data curation: WJH, HJC, AW, AM, BM, CA, and SCJB. Formal analysis: WJH, EPKP, and VW. Funding acquisition: JM, BG, and JACS. Methodology: WJH, EPKP, RHK, EJW, VW, TP, MAH, and JACS. Project administration: WJH, AM, JM, BG, CA, and JACS. Resources: WJH, HJC, AW, AM, JM, BM, SCJB, and BG. Software: WJH, EPKP, and SCJB. Supervision: MAH and JACS. Validation: WJH, EPKP, CA, and VW. Visualization: WJH, and EPKP. Writing - original draft: WJH. Writing - review & editing: WJH, EPKP, RHK, EJW, VW, TP, HJC, AW, CA, AM, JM, BM, SCJB, BG, MAH, and JACS.

## Information governance and ethical approval

NHS England is the data controller for OpenSAFELY-TPP; TPP is the data processor; and study authors using OpenSAFELY have the approval of NHS England. This implementation of OpenSAFELY is hosted within the TPP environment which is accredited to the ISO 27001 information security standard and is NHS IG Toolkit compliant @datasec; Patient data has been pseudonymised for analysis and linkage using industry standard cryptographic hashing techniques; all pseudonymised datasets transmitted for linkage onto OpenSAFELY are encrypted; access to the platform is via a virtual private network (VPN) connection, restricted to a small group of researchers; the researchers hold contracts with NHS England and only access the platform to initiate database queries and statistical models; all database activity is logged; only aggregate statistical outputs leave the platform environment following best practice for anonymisation of results such as statistical disclosure control for low cell counts @isb1523 . The OpenSAFELY research platform adheres to the obligations of the UK General Data Protection Regulation (GDPR) and the Data Protection Act 2018. In March 2020, the Secretary of State for Health and Social Care used powers under the UK Health Service (Control of Patient Information) Regulations 2002 (COPI) to require organisations to process confidential patient information for the purposes of protecting public health, providing healthcare services to the public and monitoring and managing the COVID-19 outbreak and incidents of exposure; this sets aside the requirement for patient consent @coronavi2020 . Taken together, these provide the legal bases to link patient datasets on the OpenSAFELY platform. General practices, from which the primary care data are obtained, are required to share relevant health information to support the public health response to the pandemic, and have been informed of the OpenSAFELY analytics platform.

This study was approved by the Health Research Authority (REC reference 20/LO/0651) and by the LSHTM Ethics Board (reference 21863).

JACS is the guarantor.

## Funding

This work was jointly funded by UKRI \[COV0076;MR/V015737/1\], the Longitudinal Health and Wellbeing strand of the National Core Studies programme (MC_PC_20030; MC_PC_20059; COV-LT-0009), NIHR and Asthma UK-BLF. The OpenSAFELY data science platform is funded by the Wellcome Trust (222097/Z/20/Z).

BG's work on better use of data in healthcare more broadly is currently funded in part by: the Bennett Foundation, the Wellcome Trust, NIHR Oxford Biomedical Research Centre, NIHR Applied Research Collaboration Oxford and Thames Valley, the Mohn-Westlake Foundation; all Bennett Institute staff are supported by BG's grants on this work. EW holds grants from MRC. RHK was funded by UK Research and Innovation (Future Leaders Fellowship MR/S017968/1).

The views expressed are those of the authors and not necessarily those of the NIHR, NHS England, UK Health Security Agency (UKHSA) or the Department of Health and Social Care.

Funders had no role in the study design, collection, analysis, and interpretation of data; in the writing of the report; and in the decision to submit the article for publication.

For the purpose of Open Access, the author has applied a CC BY public copyright licence to any Author Accepted Manuscript (AAM) version arising from this submission.

## Data access and verification

Access to the underlying identifiable and potentially re-identifiable pseudonymised electronic health record data is tightly governed by various legislative and regulatory frameworks, and restricted by best practice. The data in OpenSAFELY is drawn from General Practice data across England where TPP is the data processor.

TPP developers initiate an automated process to create pseudonymised records in the core OpenSAFELY database, which are copies of key structured data tables in the identifiable records. These pseudonymised records are linked onto key external data resources that have also been pseudonymised via SHA-512 one-way hashing of NHS numbers using a shared salt. Bennett Institute for Applied Data Science developers and PIs holding contracts with NHS England have access to the OpenSAFELY pseudonymised data tables as needed to develop the OpenSAFELY tools.

These tools in turn enable researchers with OpenSAFELY data access agreements to write and execute code for data management and data analysis without direct access to the underlying raw pseudonymised patient data, and to review the outputs of this code. All code for the full data management pipeline---from raw data to completed results for this analysis---and for the OpenSAFELY platform as a whole is available for review at github.com/OpenSAFELY.

\newpage

## Figures and tables

#### Table 1: Baseline characteristics before and after matching

```{r table-table1}
#| echo: false
#| warning: false
#| message: false

# tab1 <- rst$cv$match_table1_wide %>%
#   filter(
#     strategy=="post",
#     !(variable  %in% c("N", "immunosuppressed", "region"))
#   ) %>%
#   mutate(
#     smd=if_else(variable %in% c(matching_variables$B$exact, "ageband"), NA_character_, smd),
#     var_label = fct_recode(var_label, "Any immunosuppressive condition"= "Immunosuppressed (all)"),
#     order_level = row_number(),
#     order_var = cumsum(lag(variable, 1, first(variable))!=variable),
#     var_label = if_else(lag(as.character(var_label),n=1,default="")==var_label, "", as.character(var_label)),
#   ) %>%
#   select(var_label, variable_levels, stat_0, stat_1, smd, order_var, level) %>%
#   gt(
#     #groupname_col = "var_label"
#   ) %>%
#   cols_label(
#     var_label = "Variable",
#     variable_levels = " ",
#     `stat_0` = glue("Pfizer BA45 (N={filter(rst$cv$match_table1, strategy=='post', variable=='N', by==0) %>% pull(n)})"),
#     `stat_1` = glue("Sanofi (N={filter(rst$cv$match_table1, strategy=='post', variable=='N', by==1) %>% pull(n)})"),
#     `smd` = "Standardised mean difference"
#   ) %>%
#   cols_align(
#     align = c("right"),
#     columns =  c("stat_0", "stat_1")
#   ) %>%
#   cols_align(
#     align = c("left"),
#     columns =  c("var_label", "variable_levels")
#   ) %>%
#   sub_missing(
#       columns = "smd",
#       missing_text = "-"
#   ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_column_labels(everything())
#   ) %>%
#   tab_style(
#     style = list(
#       cell_fill(color = "gray96")
#     ),
#     locations = cells_body(
#       rows = order_var%%2 == 0
#     )
#   ) %>%
#   cols_hide(c("level", "order_var")) %>%
#   tab_options(
#     #row_group.as_column = TRUE,
#     table.font.size = 8
#   )



match_table1_wide_wide <-
  match_table1_wide %>%
  filter(
    strategy=="post",
    !(variable  %in% c("N", "immunosuppressed", "region"))
  ) %>%
  mutate(
    smd = if_else(variable %in% c(matching_variables$B$exact), NA_character_, smd)
  ) %>%
  pivot_wider(
    id_cols = c(var_label, variable, variable_levels, level),
    names_from = cohort,
    values_from = c(stat_0, stat_1, smd)
  ) %>%
  mutate(
    order_var = cumsum(lag(variable, 1, first(variable))!=variable)
  )

tab1 <-
  match_table1_wide_wide %>%
  gt(
    groupname_col = "var_label"
  ) %>%
  fmt_markdown(columns = "var_label") %>%
  tab_style(
    style = list(
      cell_fill(color = "gray96")
    ),
    locations = cells_body(
      rows = order_var%%2 == 0
    )
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(everything())
  ) %>%
  cols_label(
    var_label = "Variable",
    variable_levels = "",
    `stat_0_cv` = glue("Pfizer BA45 (N={filter(match_table1, strategy=='post', cohort=='cv', variable=='N', by==0) %>% pull(n)})"),
    `stat_1_cv` = glue("Sanofi (N={filter(match_table1, strategy=='post', cohort=='cv', variable=='N', by==1) %>% pull(n)})"),
   `smd_cv` = "SMD",
    `stat_0_age75plus` = glue("Pfizer BA45 (N={filter(match_table1, strategy=='post', cohort=='age75plus', variable=='N', by==0) %>% pull(n)})"),
    `stat_1_age75plus` = glue("Sanofi (N={filter(match_table1, strategy=='post', cohort=='age75plus', variable=='N', by==1) %>% pull(n)})"),
    `smd_age75plus` = "SMD"
  ) %>%
  sub_missing(
      columns = starts_with("smd_"),
      missing_text = "-"
  ) %>%
  tab_spanner(
    label = "CV",
    columns = ends_with("_cv")
  ) %>%
  tab_spanner(
    label = "75+",
    columns = ends_with("_age75plus")
  ) %>%
  cols_align(
    align = c("right"),
    columns =  ends_with(c("_cv", "_age75plus"))
  ) %>%
  cols_hide(c(
    "variable", "level", "order_var",
    #"smd_cv", "smd_age75plus",
    NULL
    )) %>% 
  tab_options(
    table.font.size = 8,
    row_group.as_column = TRUE
  )


gtsave(tab1, fs::path(output_dir_qmd, "table1.html"))

tab1

cat("  \n\n")
```

Standardised mean differences reported as "-" indicate that the variable was exactly matched on and is therefore zero by design.

All values are counts and percentages, except where "\*" indicates means and standard deviations.

Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

#### Table 2: Estimates at X-week follow-up of risk per `r perN_format` people in each vaccine group, and corresponding risk differences, overall and within subgroups

Counts and survival estimates are based on values rounded up to the nearest $6n-3$ for disclosure control.

```{r table-contrasts}
#| echo: false
#| warning: false
#| message: false

tabcontrasts <- 
  contrasts_table %>%
  filter(
    outcome %in% outcomes_primary,
    subgroup == "all"
  ) %>%
  group_by(outcome_descr) %>%
  select(
    cohort_descr,
    outcome_descr,
    
    #n.atrisk,
    
    persontime_0,
    persontime_1,
    
    n.event_0,
    n.event_1,
    
    riskCI_0,
    riskCI_1,
    
    rdCI,
    #rrCI,
    #kmirrCI,
    #coxhrCI,
  ) %>%
  mutate(
    # add indicator for row shading
    shade = cumsum((lag(as.character(outcome_descr), 1, "")!=outcome_descr)*1L),
    # remove repeat values of subgroup_level
    #subgroup_descr = if_else(lag(as.character(subgroup_descr),n=1,default="")==subgroup_descr, "", as.character(subgroup_descr)),
  ) %>%
  ungroup() %>%
  gt(groupname_col="cohort_descr") %>%
  cols_label(
    cohort_descr = "Cohort",
    outcome_descr = "Outcome",
    
    #n.atrisk = "N per group",
    
    persontime_0 = "Person-weeks", 
    persontime_1 = "Person-weeks", 
    
    n.event_0 = "Events",
    n.event_1 = "Events",
    
    riskCI_0 = glue("Risk per {perN_format} people (95% CI)"),
    riskCI_1 = glue("Risk per {perN_format} people (95% CI)"),
    
    rdCI = glue("Risk difference per {perN_format} people (95% CI)"),
    #rrCI = "Risk ratio (95% CI)",
    #kmirrCI = "Incidence rate ratio (95% CI)",
    #coxhrCI = "Hazard ratio (95% CI)"
  ) %>%
  tab_spanner(
    label = "Pfizer BA45",
    columns = ends_with("_0")
  ) %>%
   tab_spanner(
    label = "Sanofi",
    columns = ends_with("_1")
  )  %>%
   tab_spanner(
    label = "Comparison (reference=Pfizer BA45)",
    columns = ends_with("CI")
  ) %>%
  cols_align(
    align = c("right"),
    columns = ends_with(c("atrisk", "_1", "_0", "CI"))
  ) %>%
  tab_options(
    table.font.size = 8
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "gray96")
    ),
    locations = cells_body(
      rows = shade%%2 != 0
    )
  ) %>%
  cols_hide(c("shade"))
  

gtsave(tabcontrasts, fs::path(output_dir_qmd, "tabcontrasts.html"))

tabcontrasts

cat("  \n\n")
```

Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

#### Figure 1: Flow of participants into the study

```{r table-flowchart}
#| echo: false
#| warning: false
#| message: false


flowchart %>%
  select(-crit) %>%
  mutate(
    pct_step1= 1-pct_exclude
  ) %>%
  pivot_wider(
    id_cols = c(criteria, cohort_descr),
    names_from = c(boost_type),
    values_from = c(n, n_exclude, pct_all, pct_step, pct_step1)
  ) %>%
  gt(groupname_col="cohort_descr") %>%
  cols_label(
    criteria = "",
    
    n_pfizerBA45 = "N",
    n_sanofi = "N",

    n_exclude_pfizerBA45 = "N excluded",
    n_exclude_sanofi = "N excluded",
    
    pct_all_pfizerBA45 = "% (overall)",
    pct_all_sanofi = "% (overall)",
    pct_step_pfizerBA45 = "% (incremental)",
    pct_step_sanofi = "% (incremental)",
    pct_step1_pfizerBA45 = "% (incremental 2)",
    pct_step1_sanofi = "% (incremental 2)",
  ) %>%
  tab_spanner(
    label = "Pfizer BA45",
    columns = ends_with("pfizerBA45")
  ) %>%
   tab_spanner(
    label = "Sanofi",
    columns = ends_with("sanofi")
  ) %>%
  fmt_percent(
    columns = starts_with(c("pct_")),
    decimals = 1
  ) %>%
  fmt_number(
    columns = starts_with(c("n_")),
    decimals= 0
  ) %>%
  fmt_missing(
    everything(),
    missing_text="-"
  ) %>%
  tab_style(
    style=cell_text(whitespace ="pre-wrap"),
    #style=cell_text(style ="italic"),
    locations = cells_body(columns = "criteria")
  ) %>%
  tab_options(
    table.font.size = 8
  )

cat("  \n\n")
```

Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

```{r, function-ci, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%', out.height='50%', results='asis', out.extra=''}

#colourvalues <- RColorBrewer::brewer.pal(10, "Paired")[c(1,2,5,6,3,4,7,8,9,10)]
colourvalues <- c("#D55E00", "#009E73", "#CC79A7", "#56B4E9", "#CC79A7", "#56B4E9", "#0072B2")

plot_subgroup <- function(cohort, subgroup){
    
  subgroup0 <- subgroup
  
  if(subgroup=="all"){
    colour_guide <- list(guides(colour="none", fill="none", alpha="none"))
  } else{
    colour_guide <- list(guides(fill="none", alpha="none"))
  }
  

  plot_ci <- rst[[cohort]]$estimates %>%
    filter(
      subgroup==subgroup0,
      outcome %in% outcomes_primary,
      outcome != "noncoviddeath"
    ) %>%
    mutate(
      treatment_descr = fct_recode(treatment_descr, "pfizerBA45"="Pfizer BA45", "sanofi"="Sanofi"),
      colgroup = interaction(treatment_descr, subgroup_level_descr, sep=", "),
      outcome_descr = fct_relabel(outcome_descr, str_wrap, width=10)
    ) %>%
    group_by(colgroup, outcome_descr) %>%
    mutate(
      risk = if_else(outcome=="covidemergency" & time>20*7, NA_real_, risk),
      risk.ll = if_else(outcome=="covidemergency" & time>20*7, NA_real_, risk.ll),
      risk.ul = if_else(outcome=="covidemergency" & time>20*7, NA_real_, risk.ul),
      lagrisk=lag(risk,1,0),
    ) %>%
    ggplot(aes(group=colgroup, colour=treatment_descr, fill=treatment_descr, alpha=treatment_descr)) +
    geom_hline(aes(yintercept=0), colour="darkgrey")+
    #geom_step(aes(x=lagtime, y=risk*perN, linetype=treatment_descr))+
    geom_segment(aes(x=lagtime, xend=time, y=risk*perN, yend=risk*perN))+
    geom_segment(aes(x=lagtime, xend=lagtime, y=lagrisk*perN, yend=risk*perN))+
    geom_rect(aes(xmin=lagtime, xmax=time, ymin=risk.ll*perN, ymax=risk.ul*perN), alpha=0.1, colour="transparent")+
    facet_grid(rows=vars(outcome_descr), cols=vars(subgroup_level_descr), scales="free_y", switch="y")+
    scale_color_brewer(type="qual", palette="Set2", na.value="grey") +
    scale_fill_brewer(type="qual", palette="Set2", guide="none", na.value="grey") +
    #scale_color_manual(values=colourvalues, na.value="grey") +
    #scale_fill_manual(values=colourvalues, guide="none", na.value="grey") +
    scale_x_continuous(breaks = seq(0,600,28), expand = expansion(mult=c(0,0.01)), label = label_number(1, 1/7))+
    scale_y_continuous(
      expand = expansion(mult=c(0,0.01)), 
      #label=label_number_risk
    )+
    scale_alpha_discrete(range=c(0.3,0.9))+
    coord_cartesian(xlim=c(0, NA))+
    labs(
      x="Weeks",
      y=NULL,
      #title=glue("Cumulative incidence per {perN_format}"),
      colour=NULL,
      alpha=NULL,
      linetype=NULL
    )+
    guides(linetype="none", fill="none", alpha="none")+
    theme_minimal(base_size = 9)+
      theme(
        # legend.position = c(0.05,0.1),
        # legend.justification = c(0,0),
        legend.position = "bottom",
        #legend.direction = "vertical",
        axis.text.x.top=element_text(hjust=0),
  
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_blank(),
        strip.placement="outside",
        strip.text.y.left = element_text(angle=0),
  
        panel.border = element_blank(),
        panel.spacing = unit(0.8, "lines"),
  
      )+
      NULL
  
  
  
  
  plot_contrasts_data <- rst[[cohort]]$contrasts_daily %>%
    filter(
      subgroup==subgroup0,
      outcome %in% outcomes_primary
    ) %>%
    group_by(subgroup_level_descr, outcome_descr) %>%
    mutate(
      outcome_descr = fct_relabel(outcome_descr, str_wrap, width=10),
      # remove values before 7 days to avoid infinite ratios before both groups have events
      #rr = if_else(fup_start<7, NA_real_, rr),
      #rr.ll = if_else(fup_start<7, NA_real_, rr.ll),
      #rr.ul = if_else(fup_start<7, NA_real_, rr.ul),
      lagrd=lag(rd,1,0),
      lagrr=lag(rr,1,1),
      
    )
  
  plot_rr <- 
    plot_contrasts_data %>%
    group_by(subgroup_level_descr, outcome_descr) %>%
    ggplot(aes(group=subgroup_level_descr)) +
    geom_hline(aes(yintercept=1), colour="darkgrey")+
    geom_segment(aes(x=fup_start, xend=fup_end, y=rr, yend=rr))+
    geom_segment(aes(x=fup_start, xend=fup_start, y=lagrr, yend=rr))+
    geom_rect(aes(xmin=fup_start, xmax=fup_end, ymin=rr.ll, ymax=rr.ul), alpha=0.1, colour="transparent")+
    facet_grid(rows=vars(outcome_descr), scales="free_y", switch="y")+
    #scale_color_brewer(type="qual", palette="Set1", na.value="grey") +
    #scale_fill_brewer(type="qual", palette="Set1", guide="none", na.value="grey") +
    scale_x_continuous(breaks = seq(0,600,28), expand = expansion(mult=c(0,0.01)), label = label_number(1, 1/7))+
    scale_y_log10(
      expand = expansion(mult=c(0,0.01)),
      label=label_number_rr,
      sec.axis = dup_axis(breaks=NULL, labels=NULL, name = "higher risk\n<- BNT162b2 | mRNA 1273 ->")
    )+
    coord_cartesian(xlim=c(0, NA))+
    labs(
      x="Weeks",
      y=NULL,
      title="Cumulative risk ratio",
      colour=NULL
    )+
    #colour_guide+
    theme_minimal(base_size = 9)+
    theme(
      legend.position="none",
      axis.text.x.top=element_text(hjust=0),
      #axis.line.y = element_line(colour = "darkgrey"),
      #axis.line.x.top = element_line(colour = "darkgrey"),

      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      strip.background = element_blank(),
      strip.text = element_blank(),
      strip.placement="outside",
      panel.border = element_blank(),
      panel.spacing = unit(0.8, "lines")
    )+
    NULL
  
  plot_irr <- rst[[cohort]]$contrasts_cuts %>%
    # equivalent to the hazard
    filter(
      subgroup==subgroup0,
      outcome %in% outcomes_primary
    ) %>%
    group_by(outcome_descr, subgroup_level_descr) %>%
    ggplot(aes(group=subgroup_level_descr, colour=subgroup_level_descr, fill=subgroup_level_descr)) +
    geom_hline(aes(yintercept=1), colour="darkgrey")+
    geom_segment(aes(x=fup_start, xend=fup_end, y=irr, yend=irr))+
    geom_segment(aes(x=fup_start, xend=fup_start, y=lag(irr), yend=irr))+
    geom_rect(aes(xmin=fup_start, xmax=fup_end, ymin=irr.ll, ymax=irr.ul), alpha=0.1, colour="transparent")+
    facet_grid(rows=vars(outcome_descr), scales="free_y")+
    # scale_color_brewer(type="qual", palette="Set1", na.value="grey") +
    # scale_fill_brewer(type="qual", palette="Set1", guide="none", na.value="grey") +
    #scale_color_manual(values=colourvalues, na.value="grey") +
    #scale_fill_manual(values=colourvalues, guide="none", na.value="grey") +
    scale_x_continuous(breaks = seq(0,600,28), expand = expansion(mult=c(0,0.01)), label = label_number(1, 1/7))+
    scale_y_log10(
      expand = expansion(mult=c(0,0.01)),
      label=label_number_rr
    )+
    coord_cartesian(xlim=c(0, NA))+
    colour_guide+
    labs(
      x="Weeks",
      y="higher risk\n<- Pfizer BA45 | Sanofi ->",
      title="Incidence rate ratio",
      colour=NULL
    )+
    theme_minimal(base_size = 9)+
    theme(
      legend.position="none",
      axis.text.x.top=element_text(hjust=0),
      #axis.line.y = element_line(colour = "darkgrey"),
      #axis.line.x.top = element_line(colour = "darkgrey"),
      
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(),
      strip.background = element_blank(),
      strip.text = element_blank(),
      strip.placement="outside",
      panel.border = element_blank(),
      panel.spacing = unit(0.8, "lines")
    )+
    NULL
  
  
  n_subgroups <-
    rst[[cohort]]$estimates %>%
    filter(
      subgroup==subgroup0
    ) %>% 
    `[[`("subgroup_level_descr") %>%
    n_distinct()
  
  plot_combined <- patchwork::wrap_plots(
    plot_ci, 
    #plot_rd, 
    #plot_rr, 
    #plot_kmirr,
    #plot_coxhr,
    ncol=2,
    widths=c(n_subgroups,1)
  )
  
  ggsave(
    filename=glue("ci_{cohort}_{subgroup}.png"),
    path=output_dir_qmd,
    plot=plot_ci,
    unit="cm",
    width=13,
    height=13
  )

  plot_ci
}

```

#### Figure 2: Estimates of cumulative risk per `r perN_format` people (left plots) and cumulative risk ratios (right plots).

```{r, figure-ci-all}
#| echo: false
#| message: false
#| warning: false
#| out-width: '100%'
#| out-height: '50%'
#| output: 'asis'
#| out-extra: ''

plot_subgroup("cv", "all")
```

Â  Â  Â 

Â  Â  Â 

Â  Â  Â 

\newpage

#### Figure 3: Estimated incidence rate ratios at X-week follow-up comparing the effectiveness of Sanofi and Pfizer BA45, overall and within subgroups, together with p-values for between-subgroup heterogeneity.

<!-- ```{r figure-contrasts-irr} -->

<!-- #| echo: false -->

<!-- #| message: false -->

<!-- #| warning: false -->

<!-- #| fig-height: 10 -->

<!-- #| out-extra: '' -->

<!-- contrasts_plot <-  -->

<!--   contrasts_overall %>% -->

<!--   filter( -->

<!--     outcome %in% outcomes, -->

<!--     subgroup %in% c("all", "ageband", "cv"), -->

<!--   ) %>% -->

<!--   group_by(cohort_descr, outcome_descr) %>% -->

<!--   mutate( -->

<!--    # outcome_descr = fct_relabel(outcome_descr, str_wrap, width=10), -->

<!--     subgroup_level_descr = fct_rev(subgroup_level_descr), -->

<!--     subgroup_level_descr = fct_recode(subgroup_level_descr, "All"=""), -->

<!--     irrCI =   glue("{label_number_rr(irr)} ({label_number_rr(irr.ll)} - {label_number_rr(irr.ul)})"), -->

<!--     order = cumsum(lag(subgroup_descr, 1, first(subgroup_descr))!=subgroup_descr), -->

<!--     patch = (order %% 2) == 1, -->

<!--     rownum = n() - row_number() + 1 -->

<!--   ) %>% -->

<!--   group_by(cohort_descr, outcome_descr, subgroup_descr) %>% -->

<!--   mutate( -->

<!--     midgroup = mean(rownum), -->

<!--     irr.ln.p = if_else(row_number()==1 & (subgroup!="all"), irr.ln.p, NA_real_), -->

<!--     irr.ln.p = if_else(irr.ln.p<0.001, "<0.001", label_number(0.001, trim=FALSE)(irr.ln.p)) -->

<!--   ) -->

<!-- plot_irr_subgroup <- contrasts_plot %>% -->

<!--   ggplot(aes(y=subgroup_level_descr)) + -->

<!--   geom_vline(aes(xintercept=1), linetype="dotted", colour="darkgrey")+ -->

<!--   geom_point(aes(x=irr), position=position_dodge(width=-0.3))+ -->

<!--   geom_linerange(aes(xmin=irr.ll, xmax=irr.ul), position=position_dodge(width=-0.3))+ -->

<!--   geom_rect(aes(ymin=rownum-0.5, ymax=rownum+0.5, xmin=min(irr.ll), xmax=max(irr.ul), fill=patch), alpha=0.2)+ -->

<!--   #facet_grid(rows=vars(outcome_descr), scales="free", space="free_y", switch="y")+ -->

<!--   facet_wrap(vars(outcome_descr), scales="free_y", ncol=1, strip.position = "top")+ -->

<!--   scale_x_log10(label=label_number(0.1, style_negative="minus", big.mark=","), oob=~oob_squish(.,range=log(c(0.4,2), 10)), expand=expansion())+ -->

<!--   #scale_fill_brewer(type="qual", palette="Set2")+ -->

<!--   scale_fill_manual(values=c("transparent", "darkgrey"))+ -->

<!--   labs( -->

<!--     subtitle="\n\n\nX-week Hazard Ratio", -->

<!--     x="<- favours Sanofi  |  favours Pfizer BA45 ->", -->

<!--     y=NULL -->

<!--   )+ -->

<!--   theme_minimal()+ -->

<!--   theme( -->

<!--     plot.margin=grid::unit(c(0,0,0,0), "mm"), -->

<!--     plot.subtitle=element_text(hjust=0.5, vjust=0), -->

<!--     legend.position="none", -->

<!--     #panel.grid.minor.x = element_blank(), -->

<!--     panel.grid.major.y = element_blank(), -->

<!--     panel.grid.minor.y = element_blank(), -->

<!--     #strip.background = element_blank(), -->

<!--     #strip.placement="outside", -->

<!--     strip.text = element_text(hjust=0), -->

<!--     #strip.text.y.left = element_text(angle=0), -->

<!--     #strip.text.y.left = element_blank(), -->

<!--     panel.border = element_blank(), -->

<!--     panel.spacing = unit(0.5, "lines"), -->

<!--   ) -->

<!-- plot_irr_subgroup_table <- contrasts_plot %>% -->

<!--   ggplot(aes(y=subgroup_level_descr)) + -->

<!--   geom_text(aes(x=0.5, label=irrCI), hjust=0.5, vjust=0.5, size=9/.pt)+ -->

<!--   geom_rect(aes(ymin=rownum-0.5, ymax=rownum+0.5, xmin=0.2, xmax=0.8, fill=patch), alpha=0.2)+ -->

<!--   facet_wrap(vars(outcome_descr), scales="free_y", ncol=1, strip.position = "top")+ -->

<!--   scale_fill_manual(values=c("transparent", "darkgrey"))+ -->

<!--   scale_x_continuous(expand=expansion())+ -->

<!--   labs(subtitle="\nHazard\nRatio\n(95% CI)")+ -->

<!--   theme_minimal()+ -->

<!--   theme( -->

<!--     plot.margin=grid::unit(c(0,0,0,0), "mm"), -->

<!--     plot.subtitle=element_text(hjust=0.5, vjust=0), -->

<!--     legend.position="none", -->

<!--     panel.grid = element_blank(), -->

<!--     strip.text =element_text(colour="transparent"), -->

<!--     axis.text.y = element_blank(), -->

<!--     axis.title.y = element_blank(), -->

<!--     axis.text.x = element_blank(), -->

<!--     axis.title.x=element_blank(), -->

<!--     panel.border = element_blank(), -->

<!--     panel.spacing = unit(0.5, "lines"), -->

<!--   )+ -->

<!--   NULL -->

<!-- contrasts_plot %>% select(outcome_descr, subgroup_level_descr, irrCI, irr.ln.p) %>% write_csv(here("table3.csv")) -->

<!-- plot_p_subgroup_table <- contrasts_plot %>% -->

<!--   ggplot() + -->

<!--   geom_text(aes(x=0.5, y=subgroup_level_descr, label=irr.ln.p), hjust=0.5, vjust=0.5, size=9/.pt, colour="transparent")+ -->

<!--   geom_text(aes(x=0.5, y=midgroup, label=irr.ln.p), hjust=0.5, vjust=0.55, size=9/.pt)+ -->

<!--   geom_rect(aes(ymin=rownum-0.5, ymax=rownum+0.5, xmin=0, xmax=1, fill=patch), alpha=0.2)+ -->

<!--   facet_wrap(vars(outcome_descr), scales="free_y", ncol=1, strip.position = "top")+ -->

<!--   scale_fill_manual(values=c("transparent", "darkgrey"))+ -->

<!--   scale_x_continuous(expand=expansion())+ -->

<!--   labs(subtitle="P for\nbetween\nsubgroup\ndifferences")+ -->

<!--   theme_minimal()+ -->

<!--   theme( -->

<!--     plot.margin=grid::unit(c(0,0,0,0), "mm"), -->

<!--     plot.subtitle=element_text(hjust=0.5, vjust=0), -->

<!--     legend.position="none", -->

<!--     panel.grid = element_blank(), -->

<!--     strip.text =element_text(colour="transparent"), -->

<!--     axis.text.y = element_blank(), -->

<!--     axis.title.y = element_blank(), -->

<!--     axis.text.x = element_blank(), -->

<!--     axis.title.x=element_blank(), -->

<!--     panel.border = element_blank(), -->

<!--     panel.spacing = unit(0.5, "lines"), -->

<!--   )+ -->

<!--   NULL -->

<!--   plot_combined <- patchwork::wrap_plots( -->

<!--     plot_irr_subgroup,  -->

<!--     plot_irr_subgroup_table,  -->

<!--     plot_p_subgroup_table, -->

<!--     ncol=3, -->

<!--     widths=c(2,0.7,0.5) -->

<!--   ) -->

<!--   ggsave( -->

<!--     filename=glue("irr_pvals.jpeg"), -->

<!--     path=output_dir_qmd, -->

<!--     plot=plot_combined, -->

<!--     width=20, height=20, units="cm" -->

<!--   ) -->

<!-- plot_combined -->

<!-- cat("  \n\n") -->

<!-- ``` -->

\newpage

## References
